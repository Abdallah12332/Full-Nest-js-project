{"file":"/home/omar/Desktop/Protofolio_without_redis/src/auth/auth.service.spec.ts","mappings":"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","names":[],"sources":["/home/omar/Desktop/Protofolio_without_redis/src/auth/auth.service.spec.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-unsafe-assignment */\n// موكات يجب أن تكون قبل أي imports تصلح لـ hoisting\njest.mock(\"./generation\", () => ({\n  generation: jest.fn(() => ({\n    num: 123456,\n    expiresAt: new Date(\"2025-11-03T22:08:23.789Z\"),\n  })),\n}));\n\n// mock bcryptjs قبل الاستيراد\njest.mock(\"bcryptjs\", () => ({\n  hash: jest.fn(),\n  compare: jest.fn(),\n}));\n\nimport * as bcrypt from \"bcryptjs\";\nimport { Test, TestingModule } from \"@nestjs/testing\";\nimport { getRepositoryToken } from \"@nestjs/typeorm\";\nimport { JwtService } from \"@nestjs/jwt\";\nimport { ConfigService } from \"@nestjs/config\";\n\nimport { AuthService } from \"./auth.service\";\nimport { User } from \"../entities/User.entity\";\nimport { Cart } from \"../entities/Cart.entity\";\nimport { Verification } from \"../entities/Verification.entity\";\nimport { FailedAttempt } from \"../entities/FailedAttempt.entity\";\nimport { PasswordReset } from \"../entities/PasswordReset.entity\";\nimport { EmailService } from \"./Mailer\";\nimport { RefreshTokenBlacklist } from \"../entities/BlackList.entity\";\nimport { ApiResponse } from \"../common/dto/response.dto\";\n\ndescribe(\"AuthService\", () => {\n  let service: AuthService;\n  let emailService: EmailService;\n\n  // Repos كلها معرفة بالـ methods اللي يستخدمهم service\n  const mockUserRepository = {\n    findOne: jest.fn(),\n    create: jest.fn(),\n    save: jest.fn(),\n    update: jest.fn(),\n    delete: jest.fn(),\n    find: jest.fn(),\n  };\n\n  const mockCartRepository = {\n    findOne: jest.fn(),\n    create: jest.fn(),\n    save: jest.fn(),\n    update: jest.fn(),\n    delete: jest.fn(),\n    find: jest.fn(),\n  };\n\n  const mockVerificationRepository = {\n    findOne: jest.fn(),\n    create: jest.fn(),\n    save: jest.fn(),\n    update: jest.fn(),\n    delete: jest.fn(),\n    find: jest.fn(),\n  };\n\n  const mockFailedAttemptRepository = {\n    findOne: jest.fn(),\n    create: jest.fn(),\n    save: jest.fn(),\n    update: jest.fn(),\n    delete: jest.fn(),\n    find: jest.fn(),\n  };\n\n  const mockPasswordResetRepository = {\n    findOne: jest.fn(),\n    create: jest.fn(),\n    save: jest.fn(),\n    update: jest.fn(),\n    delete: jest.fn(),\n    find: jest.fn(),\n  };\n\n  const mockBlacklistRepository = {\n    findOne: jest.fn(),\n    create: jest.fn(),\n    save: jest.fn(),\n    update: jest.fn(),\n    delete: jest.fn(),\n    find: jest.fn(),\n  };\n\n  beforeEach(async () => {\n    jest.clearAllMocks();\n\n    // قيم افتراضية للـ bcrypt. يمكن تغييرها في كل اختبار باستخدام mockResolvedValueOnce\n    (bcrypt.hash as jest.Mock).mockReset();\n    (bcrypt.compare as jest.Mock).mockReset();\n    (bcrypt.hash as jest.Mock).mockResolvedValue(\"hashed-password\");\n    (bcrypt.compare as jest.Mock).mockResolvedValue(true);\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        AuthService,\n        {\n          provide: JwtService,\n          useValue: {\n            sign: jest.fn().mockReturnValue(\"mock-jwt-token\"),\n            verify: jest.fn().mockReturnValue({ sub: \"test-uuid\" }),\n          },\n        },\n        {\n          provide: ConfigService,\n          useValue: {\n            get: jest.fn(),\n          },\n        },\n        { provide: getRepositoryToken(User), useValue: mockUserRepository },\n        { provide: getRepositoryToken(Cart), useValue: mockCartRepository },\n        {\n          provide: getRepositoryToken(Verification),\n          useValue: mockVerificationRepository,\n        },\n        {\n          provide: getRepositoryToken(FailedAttempt),\n          useValue: mockFailedAttemptRepository,\n        },\n        {\n          provide: getRepositoryToken(PasswordReset),\n          useValue: mockPasswordResetRepository,\n        },\n        {\n          provide: getRepositoryToken(RefreshTokenBlacklist),\n          useValue: mockBlacklistRepository,\n        },\n        {\n          provide: EmailService,\n          useValue: {\n            Mailer: jest.fn().mockResolvedValue(\"Email sent!\"),\n            sendPasswordResetEmail: jest\n              .fn()\n              .mockResolvedValue(\"Password reset email sent!\"),\n          },\n        },\n      ],\n    }).compile();\n\n    service = module.get<AuthService>(AuthService);\n    emailService = module.get<EmailService>(EmailService);\n  });\n\n  afterEach(() => {\n    jest.clearAllMocks();\n  });\n\n  it(\"should be defined\", () => {\n    expect(service).toBeDefined();\n  });\n\n  describe(\"register_half\", () => {\n    const email = \"new@example.com\";\n    const ip = \"127.0.0.1\";\n\n    it(\"should send verification email if user does not exist\", async () => {\n      mockUserRepository.findOne.mockResolvedValueOnce(null);\n      mockVerificationRepository.findOne.mockResolvedValueOnce(null);\n\n      const mailerSpy = jest\n        .spyOn(emailService, \"Mailer\")\n        .mockResolvedValue(\"Email sent!\");\n\n      await service.register_half(email, ip);\n\n      expect(mailerSpy).toHaveBeenCalledWith(\n        email,\n        expect.objectContaining({\n          code: expect.anything(),\n          expiresAt: expect.any(Date),\n        }),\n      );\n\n      mailerSpy.mockRestore();\n    });\n\n    it(\"should throw when user already exists\", async () => {\n      mockUserRepository.findOne.mockResolvedValueOnce({ email });\n      await expect(service.register_half(email, ip)).rejects.toThrow(\n        \"انت لديك حساب انتقل الي صفحه تسجيل الدخول (login page)\",\n      );\n    });\n\n    it(\"should update existing verification record\", async () => {\n      mockUserRepository.findOne.mockResolvedValueOnce(null);\n      mockVerificationRepository.findOne.mockResolvedValueOnce({ email });\n\n      const result = await service.register_half(email, ip);\n\n      expect(mockVerificationRepository.update).toHaveBeenCalledWith(\n        { email },\n        expect.objectContaining({\n          code: expect.anything(),\n          expiresAt: expect.any(Date),\n        }),\n      );\n\n      expect(result).toBeInstanceOf(ApiResponse);\n      expect(result.success).toBe(true);\n      expect(result.message).toBe(\"Email sent!\");\n      expect(result.data).toBeUndefined();\n    });\n  });\n\n  describe(\"register_complete\", () => {\n    const email = \"new@example.com\";\n    const password = \"securePassword123\";\n\n    it(\"should throw NotFoundException if user not found\", async () => {\n      mockUserRepository.findOne.mockResolvedValueOnce(null);\n      await expect(service.register_complete(email, password)).rejects.toThrow(\n        \"user not found\",\n      );\n    });\n\n    it(\"should complete registration and return tokens\", async () => {\n      const user = { id: \"uuid-123\", email, role: \"user\", isVerified: false };\n      mockUserRepository.findOne.mockResolvedValueOnce(user);\n\n      // إعداد mock لـ bcrypt.hash بشكل صحيح\n      const hashMock = bcrypt.hash as jest.Mock;\n      hashMock.mockClear();\n      hashMock\n        .mockResolvedValueOnce(\"hashed-password\") // الاستدعاء الأول للباسورد\n        .mockResolvedValueOnce(\"hashed-refresh\"); // الاستدعاء الثاني للـ refresh token\n\n      const jwtService = service[\"jwtService\"];\n      const configService = service[\"configService\"];\n\n      jest.spyOn(jwtService, \"sign\").mockReturnValue(\"mock-token\");\n      jest.spyOn(configService, \"get\").mockReturnValue(\"1h\");\n\n      // التأكد من أن mockUserRepository.update يعمل بشكل صحيح\n      mockUserRepository.update.mockResolvedValueOnce({ affected: 1 });\n\n      const result = await service.register_complete(email, password);\n\n      // التحقق من أن findOne تم استدعاؤه\n      expect(mockUserRepository.findOne).toHaveBeenCalledWith({ where: { email } });\n      \n      // التحقق من أن bcrypt.hash تم استدعاؤه مرتين\n      expect(hashMock).toHaveBeenCalledTimes(2);\n      expect(hashMock).toHaveBeenNthCalledWith(1, password, 10);\n      expect(mockUserRepository.update).toHaveBeenCalledWith(\n        { email },\n        expect.objectContaining({\n          password: \"hashed-password\",\n          isVerified: true,\n          refresh_Token: expect.any(String),\n        }),\n      );\n      expect(result).toEqual({\n        access_token: \"mock-token\",\n        refresh_Token: \"mock-token\",\n      });\n    });\n  });\n});\n"],"version":3}