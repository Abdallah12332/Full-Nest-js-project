2e2fac307e269b70074587a1ac121600
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AllExceptionsFilter = void 0;
const common_1 = require("@nestjs/common");
const log_service_1 = require("../log.service");
let AllExceptionsFilter = class AllExceptionsFilter {
    dbLogger;
    constructor(dbLogger) {
        this.dbLogger = dbLogger;
    }
    async catch(exception, host) {
        const ctx = host.switchToHttp();
        const response = ctx.getResponse();
        const request = ctx.getRequest();
        const status = exception instanceof common_1.HttpException
            ? exception.getStatus()
            : common_1.HttpStatus.INTERNAL_SERVER_ERROR;
        const message = exception instanceof common_1.HttpException
            ? exception.message
            : String(exception);
        // Try to persist the error to DB, but don't let logging failures
        // prevent returning a response to the client.
        try {
            await this.dbLogger.error(`${request.method} ${request.url} | ${message}`, exception instanceof Error ? exception.stack : undefined, "GlobalException");
        }
        catch (logErr) {
            // Logging should never crash the exception flow. Fallback to console.
            // Keep this minimal to avoid leaking sensitive info in production logs.
            console.error("Failed to write error log to DB:", logErr);
        }
        // Always attempt to send a response. Guard against response errors too.
        try {
            response.status(status).json({
                statusCode: status,
                message: exception instanceof common_1.HttpException
                    ? exception.getResponse()
                    : "internal server error",
            });
        }
        catch (resErr) {
            // If even sending response fails, log to console so the process won't
            // silently drop the request (helps debugging "Empty reply from server").
            console.error("Failed to send error response:", resErr);
        }
    }
};
exports.AllExceptionsFilter = AllExceptionsFilter;
exports.AllExceptionsFilter = AllExceptionsFilter = __decorate([
    (0, common_1.Catch)(),
    __metadata("design:paramtypes", [typeof (_a = typeof log_service_1.LogService !== "undefined" && log_service_1.LogService) === "function" ? _a : Object])
], AllExceptionsFilter);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvb21hci9EZXNrdG9wL1Byb3RvZm9saW9fd2l0aG91dF9yZWRpcy9zcmMvbG9nL2ZpbHRlcnMvYWxsLWV4Y2VwdGlvbnMuZmlsdGVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FNd0I7QUFDeEIsZ0RBQTRDO0FBR3JDLElBQU0sbUJBQW1CLEdBQXpCLE1BQU0sbUJBQW1CO0lBQ0Q7SUFBN0IsWUFBNkIsUUFBb0I7UUFBcEIsYUFBUSxHQUFSLFFBQVEsQ0FBWTtJQUFHLENBQUM7SUFFckQsS0FBSyxDQUFDLEtBQUssQ0FBQyxTQUFrQixFQUFFLElBQW1CO1FBQ2pELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNoQyxNQUFNLFFBQVEsR0FBRyxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbkMsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBRWpDLE1BQU0sTUFBTSxHQUNWLFNBQVMsWUFBWSxzQkFBYTtZQUNoQyxDQUFDLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRTtZQUN2QixDQUFDLENBQUMsbUJBQVUsQ0FBQyxxQkFBcUIsQ0FBQztRQUV2QyxNQUFNLE9BQU8sR0FDWCxTQUFTLFlBQVksc0JBQWE7WUFDaEMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxPQUFPO1lBQ25CLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFeEIsaUVBQWlFO1FBQ2pFLDhDQUE4QztRQUM5QyxJQUFJLENBQUM7WUFDSCxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUN2QixHQUFHLE9BQU8sQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFDLEdBQUcsTUFBTSxPQUFPLEVBQUUsRUFDL0MsU0FBUyxZQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUN4RCxpQkFBaUIsQ0FDbEIsQ0FBQztRQUNKLENBQUM7UUFBQyxPQUFPLE1BQU0sRUFBRSxDQUFDO1lBQ2hCLHNFQUFzRTtZQUN0RSx3RUFBd0U7WUFFeEUsT0FBTyxDQUFDLEtBQUssQ0FBQyxrQ0FBa0MsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUM1RCxDQUFDO1FBRUQsd0VBQXdFO1FBQ3hFLElBQUksQ0FBQztZQUNILFFBQVEsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUMzQixVQUFVLEVBQUUsTUFBTTtnQkFDbEIsT0FBTyxFQUNMLFNBQVMsWUFBWSxzQkFBYTtvQkFDaEMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUU7b0JBQ3pCLENBQUMsQ0FBQyx1QkFBdUI7YUFDOUIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUFDLE9BQU8sTUFBTSxFQUFFLENBQUM7WUFDaEIsc0VBQXNFO1lBQ3RFLHlFQUF5RTtZQUV6RSxPQUFPLENBQUMsS0FBSyxDQUFDLGdDQUFnQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzFELENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQTtBQWpEWSxrREFBbUI7OEJBQW5CLG1CQUFtQjtJQUQvQixJQUFBLGNBQUssR0FBRTt5REFFaUMsd0JBQVUsb0JBQVYsd0JBQVU7R0FEdEMsbUJBQW1CLENBaUQvQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9vbWFyL0Rlc2t0b3AvUHJvdG9mb2xpb193aXRob3V0X3JlZGlzL3NyYy9sb2cvZmlsdGVycy9hbGwtZXhjZXB0aW9ucy5maWx0ZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRXhjZXB0aW9uRmlsdGVyLFxuICBDYXRjaCxcbiAgQXJndW1lbnRzSG9zdCxcbiAgSHR0cEV4Y2VwdGlvbixcbiAgSHR0cFN0YXR1cyxcbn0gZnJvbSBcIkBuZXN0anMvY29tbW9uXCI7XG5pbXBvcnQgeyBMb2dTZXJ2aWNlIH0gZnJvbSBcIi4uL2xvZy5zZXJ2aWNlXCI7XG5cbkBDYXRjaCgpXG5leHBvcnQgY2xhc3MgQWxsRXhjZXB0aW9uc0ZpbHRlciBpbXBsZW1lbnRzIEV4Y2VwdGlvbkZpbHRlciB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgZGJMb2dnZXI6IExvZ1NlcnZpY2UpIHt9XG5cbiAgYXN5bmMgY2F0Y2goZXhjZXB0aW9uOiB1bmtub3duLCBob3N0OiBBcmd1bWVudHNIb3N0KSB7XG4gICAgY29uc3QgY3R4ID0gaG9zdC5zd2l0Y2hUb0h0dHAoKTtcbiAgICBjb25zdCByZXNwb25zZSA9IGN0eC5nZXRSZXNwb25zZSgpO1xuICAgIGNvbnN0IHJlcXVlc3QgPSBjdHguZ2V0UmVxdWVzdCgpO1xuXG4gICAgY29uc3Qgc3RhdHVzID1cbiAgICAgIGV4Y2VwdGlvbiBpbnN0YW5jZW9mIEh0dHBFeGNlcHRpb25cbiAgICAgICAgPyBleGNlcHRpb24uZ2V0U3RhdHVzKClcbiAgICAgICAgOiBIdHRwU3RhdHVzLklOVEVSTkFMX1NFUlZFUl9FUlJPUjtcblxuICAgIGNvbnN0IG1lc3NhZ2UgPVxuICAgICAgZXhjZXB0aW9uIGluc3RhbmNlb2YgSHR0cEV4Y2VwdGlvblxuICAgICAgICA/IGV4Y2VwdGlvbi5tZXNzYWdlXG4gICAgICAgIDogU3RyaW5nKGV4Y2VwdGlvbik7XG5cbiAgICAvLyBUcnkgdG8gcGVyc2lzdCB0aGUgZXJyb3IgdG8gREIsIGJ1dCBkb24ndCBsZXQgbG9nZ2luZyBmYWlsdXJlc1xuICAgIC8vIHByZXZlbnQgcmV0dXJuaW5nIGEgcmVzcG9uc2UgdG8gdGhlIGNsaWVudC5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5kYkxvZ2dlci5lcnJvcihcbiAgICAgICAgYCR7cmVxdWVzdC5tZXRob2R9ICR7cmVxdWVzdC51cmx9IHwgJHttZXNzYWdlfWAsXG4gICAgICAgIGV4Y2VwdGlvbiBpbnN0YW5jZW9mIEVycm9yID8gZXhjZXB0aW9uLnN0YWNrIDogdW5kZWZpbmVkLFxuICAgICAgICBcIkdsb2JhbEV4Y2VwdGlvblwiLFxuICAgICAgKTtcbiAgICB9IGNhdGNoIChsb2dFcnIpIHtcbiAgICAgIC8vIExvZ2dpbmcgc2hvdWxkIG5ldmVyIGNyYXNoIHRoZSBleGNlcHRpb24gZmxvdy4gRmFsbGJhY2sgdG8gY29uc29sZS5cbiAgICAgIC8vIEtlZXAgdGhpcyBtaW5pbWFsIHRvIGF2b2lkIGxlYWtpbmcgc2Vuc2l0aXZlIGluZm8gaW4gcHJvZHVjdGlvbiBsb2dzLlxuXG4gICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIHdyaXRlIGVycm9yIGxvZyB0byBEQjpcIiwgbG9nRXJyKTtcbiAgICB9XG5cbiAgICAvLyBBbHdheXMgYXR0ZW1wdCB0byBzZW5kIGEgcmVzcG9uc2UuIEd1YXJkIGFnYWluc3QgcmVzcG9uc2UgZXJyb3JzIHRvby5cbiAgICB0cnkge1xuICAgICAgcmVzcG9uc2Uuc3RhdHVzKHN0YXR1cykuanNvbih7XG4gICAgICAgIHN0YXR1c0NvZGU6IHN0YXR1cyxcbiAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICBleGNlcHRpb24gaW5zdGFuY2VvZiBIdHRwRXhjZXB0aW9uXG4gICAgICAgICAgICA/IGV4Y2VwdGlvbi5nZXRSZXNwb25zZSgpXG4gICAgICAgICAgICA6IFwiaW50ZXJuYWwgc2VydmVyIGVycm9yXCIsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChyZXNFcnIpIHtcbiAgICAgIC8vIElmIGV2ZW4gc2VuZGluZyByZXNwb25zZSBmYWlscywgbG9nIHRvIGNvbnNvbGUgc28gdGhlIHByb2Nlc3Mgd29uJ3RcbiAgICAgIC8vIHNpbGVudGx5IGRyb3AgdGhlIHJlcXVlc3QgKGhlbHBzIGRlYnVnZ2luZyBcIkVtcHR5IHJlcGx5IGZyb20gc2VydmVyXCIpLlxuXG4gICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIHNlbmQgZXJyb3IgcmVzcG9uc2U6XCIsIHJlc0Vycik7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=