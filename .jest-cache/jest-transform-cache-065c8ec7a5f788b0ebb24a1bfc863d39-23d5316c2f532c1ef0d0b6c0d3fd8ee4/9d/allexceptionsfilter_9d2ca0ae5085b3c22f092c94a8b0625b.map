{"version":3,"names":["cov_6bxay3680","actualCoverage","common_1","s","require","log_service_1","AllExceptionsFilter","dbLogger","constructor","f","catch","exception","host","ctx","switchToHttp","response","getResponse","request","getRequest","status","HttpException","b","getStatus","HttpStatus","INTERNAL_SERVER_ERROR","message","String","error","method","url","Error","stack","undefined","logErr","console","json","statusCode","resErr","exports","__decorate","Catch","LogService","_a","Object"],"sources":["/home/omar/Desktop/Protofolio_without_redis/src/log/filters/all-exceptions.filter.ts"],"sourcesContent":["import {\n  ExceptionFilter,\n  Catch,\n  ArgumentsHost,\n  HttpException,\n  HttpStatus,\n} from \"@nestjs/common\";\nimport { LogService } from \"../log.service\";\n\n@Catch()\nexport class AllExceptionsFilter implements ExceptionFilter {\n  constructor(private readonly dbLogger: LogService) {}\n\n  async catch(exception: unknown, host: ArgumentsHost) {\n    const ctx = host.switchToHttp();\n    const response = ctx.getResponse();\n    const request = ctx.getRequest();\n\n    const status =\n      exception instanceof HttpException\n        ? exception.getStatus()\n        : HttpStatus.INTERNAL_SERVER_ERROR;\n\n    const message =\n      exception instanceof HttpException\n        ? exception.message\n        : String(exception);\n\n    // Try to persist the error to DB, but don't let logging failures\n    // prevent returning a response to the client.\n    try {\n      await this.dbLogger.error(\n        `${request.method} ${request.url} | ${message}`,\n        exception instanceof Error ? exception.stack : undefined,\n        \"GlobalException\",\n      );\n    } catch (logErr) {\n      // Logging should never crash the exception flow. Fallback to console.\n      // Keep this minimal to avoid leaking sensitive info in production logs.\n\n      console.error(\"Failed to write error log to DB:\", logErr);\n    }\n\n    // Always attempt to send a response. Guard against response errors too.\n    try {\n      response.status(status).json({\n        statusCode: status,\n        message:\n          exception instanceof HttpException\n            ? exception.getResponse()\n            : \"internal server error\",\n      });\n    } catch (resErr) {\n      // If even sending response fails, log to console so the process won't\n      // silently drop the request (helps debugging \"Empty reply from server\").\n\n      console.error(\"Failed to send error response:\", resErr);\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAUa;IAAAA,aAAA,YAAAA,CAAA;MAAA,OAAA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","ignoreList":[]}