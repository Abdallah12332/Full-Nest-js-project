{"version":3,"names":["core_1","cov_2j9qf24ts9","s","require","common_1","app_module_1","cookie_parser_1","__importDefault","helmet_1","jwt_1","fs","__importStar","compression","swagger_1","config_1","express","bootstrap","f","httpsOptions","key","readFileSync","cert","app","NestFactory","create","AppModule","configService","get","ConfigService","use","default","level","urlencoded","extended","json","set","contentSecurityPolicy","useDefaults","directives","useGlobalPipes","ValidationPipe","whitelist","forbidNonWhitelisted","transform","jwtService","JwtService","req","res","next","auth","b","headers","authorization","startsWith","status","message","token","split","payload","verify","role","user","enableCors","origin","credentials","allowedHeaders","swaggerDocument","JSON","parse","SwaggerModule","setup","listen","console","log","catch","err","error","process","exit"],"sources":["/home/omar/Desktop/Protofolio_without_redis/src/main.ts"],"sourcesContent":["import { NestFactory } from \"@nestjs/core\";\nimport { ValidationPipe } from \"@nestjs/common\";\nimport { AppModule } from \"./app.module\";\nimport cookieParser from \"cookie-parser\";\nimport { NestExpressApplication } from \"@nestjs/platform-express\";\nimport helmet from \"helmet\";\nimport { JwtService } from \"@nestjs/jwt\";\nimport * as fs from \"fs\";\nimport * as compression from \"compression\";\nimport { OpenAPIObject, SwaggerModule } from \"@nestjs/swagger\";\nimport { ConfigService } from \"@nestjs/config\";\nimport * as express from \"express\";\n\nasync function bootstrap() {\n  const httpsOptions = {\n    key: fs.readFileSync(\"./secrets/private-key.pem\"),\n    cert: fs.readFileSync(\"./secrets/certificate.pem\"),\n  };\n\n  const app = await NestFactory.create<NestExpressApplication>(AppModule, {\n    httpsOptions,\n  });\n\n  const configService = app.get(ConfigService);\n  // Enable gzip compression\n  app.use(compression.default({ level: 6 }));\n  app.use(cookieParser());\n  app.use(express.urlencoded({ extended: false }));\n  app.use(express.json());\n\n  // Cookie parser\n\n  // Trust proxy (for HTTPS behind reverse proxy)\n  app.set(\"trust proxy\", 1);\n\n  // Helmet security headers\n  app.use(\n    helmet({\n      contentSecurityPolicy: {\n        useDefaults: true,\n        directives: {\n          \"default-src\": [\"'self'\"],\n          \"script-src\": [\"'self'\", \"https://apis.google.com\"],\n          \"style-src\": [\"'self'\"],\n          \"img-src\": [\"'self'\", \"data:\", \"https:\"],\n          \"connect-src\": [\"'self'\", `${configService.get(\"CORS\")}`],\n          \"font-src\": [\"'self'\", \"https://fonts.gstatic.com\"],\n          \"frame-src\": [\"'none'\", \"https://accounts.google.com\"],\n          \"frame-ancestors\": [\"'none'\"],\n        },\n      },\n    }),\n  );\n\n  // Global validation\n  app.useGlobalPipes(\n    new ValidationPipe({\n      whitelist: true,\n      forbidNonWhitelisted: true,\n      transform: true,\n    }),\n  );\n\n  const jwtService = app.get(JwtService);\n\n  // Admin guard for Swagger\n  app.use(\n    \"/api/docs\",\n    (\n      req: { headers: { authorization?: string }; user?: any },\n      res: {\n        status: (code: number) => { json: (obj: { message: string }) => void };\n      },\n      next: () => void,\n    ): void => {\n      try {\n        const auth = req.headers.authorization ?? \"\";\n        if (!auth.startsWith(\"Bearer \")) {\n          res.status(401).json({ message: \"Unauthorized\" });\n          return;\n        }\n\n        const token: string = auth.split(\" \")[1];\n        const payload: { role?: string } = jwtService.verify(token);\n\n        if (payload.role !== \"admin\") {\n          res.status(403).json({ message: \"Admins only\" });\n          return;\n        }\n\n        req.user = payload;\n        next();\n      } catch {\n        res.status(401).json({ message: \"Invalid token\" });\n      }\n    },\n  );\n\n  // Enable CORS\n  app.enableCors({\n    origin: configService.get(\"CORS\"),\n    credentials: true,\n    allowedHeaders: [\"Content-Type\", \"Authorization\", \"X-CSRF-Token\"],\n  });\n\n  // Load prebuilt Swagger document\n  const swaggerDocument: OpenAPIObject = JSON.parse(\n    fs.readFileSync(\"./swagger.json\", \"utf-8\"),\n  ) as OpenAPIObject;\n  SwaggerModule.setup(\"api/docs\", app, swaggerDocument);\n\n  await app.listen(configService.get(\"PORT\") ?? 8443);\n  console.log(\n    `Swagger docs available at https://localhost:${configService.get(\"PORT\") ?? 8443}/api/docs`,\n  );\n}\n\nbootstrap().catch((err) => {\n  console.error(\"Error during bootstrap:\", err);\n  process.exit(1);\n});\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}