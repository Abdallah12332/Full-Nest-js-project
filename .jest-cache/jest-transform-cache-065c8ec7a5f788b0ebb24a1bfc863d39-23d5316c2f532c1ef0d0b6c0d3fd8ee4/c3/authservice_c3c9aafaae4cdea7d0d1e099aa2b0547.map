{"file":"/home/omar/Desktop/Protofolio_without_redis/src/auth/auth.service.ts","mappings":"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","names":[],"sources":["/home/omar/Desktop/Protofolio_without_redis/src/auth/auth.service.ts"],"sourcesContent":["import {\n  BadRequestException,\n  Injectable,\n  NotFoundException,\n  HttpException,\n  HttpStatus,\n  UnauthorizedException,\n} from \"@nestjs/common\";\nimport { User } from \"../entities/User.entity\";\nimport { InjectRepository } from \"@nestjs/typeorm\";\nimport { Repository } from \"typeorm\";\nimport { Cart } from \"../entities/Cart.entity\";\nimport { JwtService } from \"@nestjs/jwt\";\nimport { generation } from \"./generation\";\nimport { EmailService } from \"./Mailer\";\nimport { Verification } from \"../entities/Verification.entity\";\nimport { FailedAttempt } from \"../entities/FailedAttempt.entity\";\nimport { PasswordReset } from \"../entities/PasswordReset.entity\";\nimport * as bcrypt from \"bcryptjs\";\nimport * as crypto from \"crypto\";\nimport { GoogleProfile } from \"./GoogleProfile\";\nimport { JwtPayload } from \"./JwtPayload\";\nimport { ApiResponse } from \"../common/dto/response.dto\";\nimport { RefreshTokenBlacklist } from \"../entities/BlackList.entity\";\nimport { ConfigService } from \"@nestjs/config\";\n\n@Injectable()\nexport class AuthService {\n  constructor(\n    private jwtService: JwtService,\n    @InjectRepository(User)\n    private readonly userRepository: Repository<User>,\n    @InjectRepository(Cart)\n    private readonly CartRepo: Repository<Cart>,\n    @InjectRepository(Verification)\n    private readonly VerficationRepo: Repository<Verification>,\n    @InjectRepository(FailedAttempt)\n    private readonly FailedAttemptRepo: Repository<FailedAttempt>,\n    @InjectRepository(PasswordReset)\n    private readonly PasswordResetRepo: Repository<PasswordReset>,\n    @InjectRepository(RefreshTokenBlacklist)\n    private readonly blacklistRepo: Repository<RefreshTokenBlacklist>,\n    private readonly EmailService: EmailService,\n    private readonly configService: ConfigService,\n  ) {}\n\n  // Rate limiting helper methods\n  private async checkRateLimit(\n    email: string,\n    ipAddress: string,\n    type: \"login\" | \"verification\",\n  ): Promise<void> {\n    // Check rate limit for this specific email+ip combination\n    const attempt = await this.FailedAttemptRepo.findOne({\n      where: { email, ipAddress, type },\n    });\n\n    if (attempt) {\n      // Check if account is locked\n      if (attempt.lockedUntil && new Date() < attempt.lockedUntil) {\n        const remainingTime = Math.ceil(\n          (attempt.lockedUntil.getTime() - Date.now()) / 60000,\n        );\n        throw new HttpException(\n          `Account temporarily locked. Try again in ${remainingTime} minutes.`,\n          HttpStatus.TOO_MANY_REQUESTS,\n        );\n      }\n\n      // Check attempt count\n      const maxAttempts = type === \"login\" ? 5 : 3;\n      const lockDuration = type === \"login\" ? 30 : 15; // minutes\n\n      if (attempt.attempts >= maxAttempts) {\n        const lockUntil = new Date(Date.now() + lockDuration * 60 * 1000);\n        // Update the specific email+ip record\n        await this.FailedAttemptRepo.update(\n          { email, ipAddress, type },\n          { lockedUntil: lockUntil },\n        );\n        throw new HttpException(\n          `Too many failed attempts. Account locked for ${lockDuration} minutes.`,\n          HttpStatus.TOO_MANY_REQUESTS,\n        );\n      }\n    }\n  }\n\n  private async recordFailedAttempt(\n    email: string,\n    ipAddress: string,\n    type: \"login\" | \"verification\",\n  ): Promise<void> {\n    // Find existing attempt for this email+ip combination\n    const attempt = await this.FailedAttemptRepo.findOne({\n      where: { email, ipAddress, type },\n    });\n\n    // Update or create attempt record\n    if (attempt) {\n      await this.FailedAttemptRepo.update(\n        { email, ipAddress, type },\n        {\n          attempts: attempt.attempts + 1,\n          lastAttempt: new Date(),\n        },\n      );\n    } else {\n      const newAttempt = this.FailedAttemptRepo.create({\n        email,\n        ipAddress,\n        type,\n        attempts: 1,\n        lastAttempt: new Date(),\n      });\n      await this.FailedAttemptRepo.save(newAttempt);\n    }\n  }\n\n  private async clearFailedAttempts(\n    email: string,\n    ipAddress: string,\n    type: \"login\" | \"verification\",\n  ): Promise<void> {\n    const attempt = await this.FailedAttemptRepo.findOne({\n      where: { email, ipAddress, type },\n    });\n\n    if (attempt) {\n      await this.FailedAttemptRepo.update(\n        { email, ipAddress, type },\n        {\n          attempts: 0,\n          lockedUntil: undefined,\n          lastAttempt: new Date(),\n        },\n      );\n    }\n  }\n\n  async register_half(email: string, ipAddress: string) {\n    // Check rate limit for verification codes\n    await this.checkRateLimit(email, ipAddress, \"verification\");\n\n    const user = await this.userRepository.findOne({ where: { email } });\n    if (user) {\n      throw new BadRequestException(\n        \"انت لديك حساب انتقل الي صفحه تسجيل الدخول (login page)\",\n      );\n    }\n    const ok = await this.VerficationRepo.findOne({ where: { email } });\n\n    const { num, expiresAt } = generation();\n    const dto = {\n      code: num,\n      expiresAt: expiresAt,\n    };\n    await this.EmailService.Mailer(email, dto);\n    const Verfication = {\n      email,\n      code: num,\n      expiresAt,\n    };\n    if (!ok) {\n      const createable = this.VerficationRepo.create(Verfication);\n      await this.VerficationRepo.save(createable);\n    } else {\n      await this.VerficationRepo.update(\n        { email },\n        { code: dto.code, expiresAt },\n      );\n    }\n\n    return ApiResponse.success(\"Email sent!\");\n  }\n  async register_full(email: string, code: string, ipAddress: string) {\n    const ok = await this.VerficationRepo.findOne({ where: { email } });\n    if (!ok) {\n      throw new NotFoundException(\"Email:code not found\");\n    }\n    if (new Date() > ok.expiresAt) {\n      throw new BadRequestException(\"code is expired\");\n    }\n    if (ok.code !== code) {\n      // Record failed verification attempt\n      await this.recordFailedAttempt(email, ipAddress, \"verification\");\n      throw new BadRequestException(\"invalid code\");\n    }\n\n    // Clear failed attempts on successful verification\n    await this.clearFailedAttempts(email, ipAddress, \"verification\");\n    await this.VerficationRepo.delete({ email });\n\n    const user = this.userRepository.create({\n      email: email,\n      provider: \"local\",\n      isVerified: false,\n      googleId: undefined,\n      role: \"user\",\n    });\n    await this.userRepository.save(user);\n    const cart = this.CartRepo.create({ user: user });\n    await this.CartRepo.save(cart);\n    return ApiResponse.success(\"Code verified successfully\");\n  }\n  async register_complete(email: string, password: string) {\n    const user = await this.userRepository.findOne({ where: { email } });\n    if (!user) {\n      throw new NotFoundException(\"user not found\");\n    }\n    if (user.isVerified === true) {\n      throw new BadRequestException(\"that's verified user\");\n    }\n\n    const hashed_password = await bcrypt.hash(password, 10);\n\n    const payload: JwtPayload = {\n      sub: user.id,\n      username: user.email,\n      role: user.role,\n    };\n    const envrefresh = String(\n      this.configService.get<string>(\"JWT_EXPIRES_REFRESHTOKEN\"),\n    );\n    const refresh_Token = this.jwtService.sign(payload, {\n      expiresIn: envrefresh,\n      issuer: \"Protofolio\",\n    });\n    const hashed_refersh_Token = await bcrypt.hash(refresh_Token, 10);\n    await this.userRepository.update(\n      { email },\n      {\n        password: hashed_password,\n        isVerified: true,\n        refresh_Token: hashed_refersh_Token,\n      },\n    );\n    const access_token = this.jwtService.sign(payload, {\n      issuer: \"Protofolio\",\n    });\n    return { access_token: access_token, refresh_Token: refresh_Token };\n  }\n\n  async login(email?: string, password?: string, ipAddress?: string) {\n    // Check rate limit for login attempts\n    if (email && ipAddress) {\n      await this.checkRateLimit(email, ipAddress, \"login\");\n    }\n\n    const user = await this.userRepository.findOne({ where: { email } });\n    if (!user) {\n      if (email && ipAddress)\n        await this.recordFailedAttempt(email, ipAddress, \"login\");\n      throw new NotFoundException(\"User not found\");\n    }\n    const hashed_password = user.password;\n    if (!hashed_password) {\n      if (email && ipAddress)\n        await this.recordFailedAttempt(email, ipAddress, \"login\");\n      throw new NotFoundException(\"password not set\");\n    }\n    if (!password) {\n      if (email && ipAddress)\n        await this.recordFailedAttempt(email, ipAddress, \"login\");\n      throw new NotFoundException(\"write password\");\n    }\n    if (user.isVerified === false) {\n      throw new UnauthorizedException(\"blocked\");\n    }\n    const ok = await bcrypt.compare(password, hashed_password);\n    if (!ok) {\n      if (email && ipAddress)\n        await this.recordFailedAttempt(email, ipAddress, \"login\");\n      throw new BadRequestException(\"password is wrong\");\n    }\n\n    // Clear failed attempts on successful login\n    if (email && ipAddress)\n      await this.clearFailedAttempts(email, ipAddress, \"login\");\n\n    const payload = {\n      id: user.id,\n      email: user.email,\n    };\n    const envrefresh = String(\n      this.configService.get<string>(\"JWT_EXPIRES_REFRESHTOKEN\"),\n    );\n    const refresh_Token = this.jwtService.sign(payload, {\n      expiresIn: envrefresh,\n      issuer: \"Protofolio\",\n    });\n    const hashed_refersh_Token = await bcrypt.hash(refresh_Token, 10);\n    await this.userRepository.update(\n      { email: user.email },\n      { refresh_Token: hashed_refersh_Token },\n    );\n    const login_token = this.jwtService.sign(payload, { issuer: \"Protofolio\" });\n    return { access_token: login_token, refresh_Token: refresh_Token };\n  }\n  // Password reset methods\n  async requestPasswordReset(email: string) {\n    const user = await this.userRepository.findOne({ where: { email } });\n    if (!user) {\n      throw new NotFoundException(\"User not found\");\n    }\n\n    // Check if user has a password set\n    if (!user.password) {\n      throw new BadRequestException(\"Password not set for this account\");\n    }\n    if (user.isVerified === false) {\n      throw new UnauthorizedException(\"Blocked\");\n    }\n\n    // Generate reset token\n    const token = crypto.randomBytes(32).toString(\"hex\");\n    const expiresAt = new Date(Date.now() + 60 * 60 * 1000); // 1 hour\n\n    // Delete any existing reset tokens for this email\n    await this.PasswordResetRepo.delete({ email });\n\n    // Create new reset token\n    const passwordReset = this.PasswordResetRepo.create({\n      email,\n      token,\n      expiresAt,\n      used: false,\n    });\n    await this.PasswordResetRepo.save(passwordReset);\n\n    // Send reset email\n    const resetDto = {\n      code: token,\n      expiresAt: expiresAt,\n    };\n    await this.EmailService.sendPasswordResetEmail(email, resetDto);\n\n    return ApiResponse.success(\"Password reset email sent!\");\n  }\n\n  async confirmPasswordReset(\n    email: string,\n    token: string,\n    newPassword: string,\n  ) {\n    const resetRecord = await this.PasswordResetRepo.findOne({\n      where: { email, token },\n    });\n\n    if (!resetRecord) {\n      throw new NotFoundException(\"Invalid reset token\");\n    }\n\n    if (resetRecord.used) {\n      throw new BadRequestException(\"Reset token already used\");\n    }\n\n    if (new Date() > resetRecord.expiresAt) {\n      throw new BadRequestException(\"Reset token expired\");\n    }\n\n    const user = await this.userRepository.findOne({ where: { email } });\n    if (!user) {\n      throw new NotFoundException(\"User not found\");\n    }\n\n    // Hash new password\n    const hashedPassword = await bcrypt.hash(newPassword, 10);\n\n    // Update user password\n    await this.userRepository.update({ email }, { password: hashedPassword });\n\n    // Mark token as used\n    await this.PasswordResetRepo.update({ email, token }, { used: true });\n\n    return ApiResponse.success(\"Password reset successful!\");\n  }\n  // تحسين دالة log_out\n  async log_out(email: string, refresh_Token: string) {\n    if (!refresh_Token) {\n      throw new BadRequestException(\"Refresh token is required\");\n    }\n\n    // البحث عن المستخدم\n    const user = await this.userRepository.findOne({ where: { email } });\n    if (!user) {\n      throw new NotFoundException(\"User not found\");\n    }\n    // التحقق من أن الـ refresh token يطابق المخزن\n    const isValidToken = user.refresh_Token\n      ? await bcrypt.compare(refresh_Token, user.refresh_Token)\n      : false;\n    if (!isValidToken) {\n      throw new UnauthorizedException(\"Invalid refresh token\");\n    }\n\n    // إضافة الـ refresh token للقائمة السوداء\n    await this.blacklistRepo.save({ token: refresh_Token });\n\n    // مسح الـ refresh token من قاعدة البيانات\n    await this.userRepository.update({ email }, { refresh_Token: null });\n\n    return ApiResponse.success(\"Logged out successfully\");\n  }\n\n  async validateGoogleUser(profile: GoogleProfile) {\n    if (!profile.emails || profile.emails.length === 0) {\n      throw new BadRequestException(\"Email not found\");\n    }\n\n    let user = await this.userRepository.findOne({\n      where: { email: profile.emails[0].value },\n    });\n\n    if (!user) {\n      user = this.userRepository.create({\n        email: profile.emails[0].value,\n        name: profile.displayName,\n        Photo: profile.photos?.[0]?.value,\n        googleId: profile.id,\n        provider: \"google\",\n        isVerified: true,\n        role: \"user\",\n      });\n      await this.userRepository.save(user);\n\n      const cart = this.CartRepo.create({ user });\n      await this.CartRepo.save(cart);\n    } else if (!user.googleId) {\n      if (!user.isVerified) {\n        throw new UnauthorizedException(\"Blocked\");\n      }\n      await this.userRepository.update(\n        { id: user.id },\n        {\n          googleId: profile.id,\n          provider: \"google\",\n          isVerified: true,\n          Photo: profile.photos?.[0]?.value,\n          name: profile.displayName,\n        },\n      );\n    }\n\n    // إنشاء payload وJWT\n    const payload: JwtPayload = {\n      sub: user.id,\n      username: user.email,\n      role: user.role,\n    };\n    const token = this.jwtService.sign(payload, { issuer: \"Protofolio\" });\n\n    const envrefresh = String(\n      this.configService.get<string>(\"JWT_EXPIRES_REFRESHTOKEN\"),\n    );\n    // إنشاء refresh token مشفر\n    const refreshToken = this.jwtService.sign(payload, {\n      expiresIn: envrefresh,\n      issuer: \"Protofolio\",\n    });\n    const hashedRefreshToken = await bcrypt.hash(refreshToken, 10);\n    await this.userRepository.update(\n      { email: user.email },\n      { refresh_Token: hashedRefreshToken },\n    );\n\n    return {\n      user: {\n        id: user.id,\n        email: user.email,\n        name: user.name,\n        photo: user.Photo,\n        role: user.role,\n      },\n      token,\n      refresh_Token: refreshToken,\n    };\n  }\n  async update_token(\n    email: string,\n    refreshToken: string,\n  ): Promise<{ access_token: string }> {\n    // التحقق من صحة التوكن أولاً\n\n    try {\n      this.jwtService.verify(refreshToken, {\n        issuer: \"Protofolio\",\n      });\n    } catch {\n      throw new UnauthorizedException(\"Invalid or expired refresh token\");\n    }\n\n    // التحقق من القائمة السوداء - باستخدام التوكن الأصلي (غير المشفر)\n    const isBlacklisted = await this.blacklistRepo.findOne({\n      where: { token: refreshToken },\n    });\n    if (isBlacklisted) {\n      throw new UnauthorizedException(\"Refresh token has been revoked\");\n    }\n\n    // البحث عن المستخدم\n    const user = await this.userRepository.findOne({ where: { email } });\n    if (!user) {\n      throw new NotFoundException(\"User not found\");\n    }\n\n    // التحقق من حالة المستخدم\n    if (!user.isVerified) {\n      throw new UnauthorizedException(\"User not verified\");\n    }\n\n    // التحقق من وجود refresh token مخزن\n    if (!user.refresh_Token) {\n      throw new UnauthorizedException(\"No refresh token stored\");\n    }\n\n    // تحقق من تطابق refresh token مع المخزن في قاعدة البيانات\n    const isMatch = await bcrypt.compare(refreshToken, user.refresh_Token);\n    if (!isMatch) {\n      throw new UnauthorizedException(\"Refresh token mismatch\");\n    }\n\n    // إنشاء tokens جديدة\n    const newPayload = { sub: user.id, username: user.email, role: user.role };\n\n    const access_token = this.jwtService.sign(newPayload, {\n      issuer: \"Protofolio\",\n      expiresIn: \"15m\",\n    });\n\n    // إبطال الـ refresh token القديم\n    await this.blacklistRepo.save({ token: refreshToken });\n\n    return {\n      access_token,\n    };\n  }\n}\n"],"version":3}