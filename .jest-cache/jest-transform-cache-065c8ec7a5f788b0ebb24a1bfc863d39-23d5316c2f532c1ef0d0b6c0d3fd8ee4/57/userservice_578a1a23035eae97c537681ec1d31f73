f52f3fdafea33c752f351564383556a2
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a, _b, _c, _d, _e;
Object.defineProperty(exports, "__esModule", { value: true });
exports.UserService = void 0;
const common_1 = require("@nestjs/common");
const typeorm_1 = require("@nestjs/typeorm");
const typeorm_2 = require("typeorm");
const Cart_entity_1 = require("../entities/Cart.entity");
const User_entity_1 = require("../entities/User.entity");
const Product_entity_1 = require("../entities/Product.entity");
const Review_entity_1 = require("../entities/Review.entity");
const Cart_Item_entity_1 = require("../entities/Cart_Item.entity");
let UserService = class UserService {
    UserRepo;
    CartRepo;
    ProductRepo;
    ReviewRepo;
    CartItemRepo;
    constructor(UserRepo, CartRepo, ProductRepo, ReviewRepo, CartItemRepo) {
        this.UserRepo = UserRepo;
        this.CartRepo = CartRepo;
        this.ProductRepo = ProductRepo;
        this.ReviewRepo = ReviewRepo;
        this.CartItemRepo = CartItemRepo;
    }
    async Add_Review(email, comment, productId, rating) {
        const user = await this.UserRepo.findOne({ where: { email: email } });
        if (!user || user.isVerified === false) {
            throw new common_1.NotFoundException("email not found");
        }
        const product = await this.ProductRepo.findOne({
            where: { id: productId },
        });
        if (!product) {
            throw new common_1.NotFoundException("product not found");
        }
        const review = this.ReviewRepo.create({
            user: user,
            product: product,
            comment: comment,
            rating: rating,
        });
        await this.ReviewRepo.save(review);
        return "ok";
    }
    async Edit_Review(email, reviewId, comment, rating) {
        const review = await this.ReviewRepo.findOne({
            where: { id: reviewId },
            relations: ["user"],
        });
        if (!review)
            throw new common_1.NotFoundException("review not found");
        if (!review.user || review.user.email !== email)
            throw new common_1.NotFoundException("not authorized or review not found");
        const updated = {};
        if (typeof comment !== "undefined")
            updated.comment = comment;
        if (typeof rating !== "undefined")
            updated.rating = rating;
        await this.ReviewRepo.update({ id: reviewId }, updated);
        return "ok";
    }
    async Remove_Review(email, reviewId) {
        const review = await this.ReviewRepo.findOne({
            where: { id: reviewId },
            relations: ["user"],
        });
        if (!review)
            throw new common_1.NotFoundException("review not found");
        if (!review.user || review.user.email !== email)
            throw new common_1.NotFoundException("not authorized or review not found");
        await this.ReviewRepo.delete({ id: reviewId });
        return "ok";
    }
    async Add_Cart_Item(cartId, productId) {
        const cart = await this.CartRepo.findOneBy({ id: cartId });
        if (!cart) {
            throw new common_1.NotFoundException("cart not found");
        }
        const Product = await this.ProductRepo.findOneBy({ id: productId });
        if (!Product) {
            throw new common_1.NotFoundException("Product not found");
        }
        const cartItem = await this.CartItemRepo.findOne({
            where: { cart: { id: cartId }, product: { id: productId } },
            relations: ["cart", "product"],
        });
        if (cartItem) {
            throw new common_1.BadRequestException("Item already in cart");
        }
        const Cart_Item = this.CartItemRepo.create({
            quantity: 1,
            cart: cart,
            product: Product,
        });
        await this.CartItemRepo.save(Cart_Item);
        return "ok";
    }
    async Remove_Cart_Item(cartId, productId) {
        const cart = await this.CartRepo.findOneBy({ id: cartId });
        if (!cart) {
            throw new common_1.NotFoundException("cart not found");
        }
        const product = await this.ProductRepo.findOneBy({ id: productId });
        if (!product) {
            throw new common_1.NotFoundException("Product not found");
        }
        const cartItem = await this.CartItemRepo.findOne({
            where: { cart: { id: cartId }, product: { id: productId } },
            relations: ["cart", "product"],
        });
        if (!cartItem) {
            throw new common_1.NotFoundException("cart item not found");
        }
        await this.CartItemRepo.remove(cartItem);
        return "ok";
    }
    async increase_Quantity(cartItemId) {
        const cartItem = await this.CartItemRepo.findOneBy({ id: cartItemId });
        if (!cartItem) {
            throw new common_1.NotFoundException("cartItem not found");
        }
        if (cartItem.quantity >= 999) {
            return "no";
        }
        cartItem.quantity++;
        await this.CartItemRepo.save(cartItem);
        return "ok";
    }
    async decrease_Quantity(cartItemId) {
        const cartItem = await this.CartItemRepo.findOneBy({ id: cartItemId });
        if (!cartItem) {
            throw new common_1.NotFoundException("cartItem not found");
        }
        if (cartItem.quantity <= 1) {
            return "no";
        }
        cartItem.quantity--;
        await this.CartItemRepo.save(cartItem);
        return "ok";
    }
    async SearchProducts(searchTerm, page) {
        try {
            const limit = 20;
            const skip = (Math.max(1, page) - 1) * limit;
            const qb = this.ProductRepo.createQueryBuilder("product")
                .where("product.name LIKE :searchTerm", {
                searchTerm: `%${searchTerm}%`,
            })
                .orWhere("product.description LIKE :searchTerm", {
                searchTerm: `%${searchTerm}%`,
            })
                .leftJoinAndSelect("product.reviews", "reviews")
                .skip(skip)
                .take(limit);
            const [products, total] = await qb.getManyAndCount();
            const totalPages = Math.max(1, Math.ceil(total / limit));
            const result = { products, currentPage: page, totalPages };
            return result;
        }
        catch (err) {
            throw new Error("Failed to search products: " + err);
        }
    }
    async FindProductsByCategory(categoryId, page) {
        try {
            const limit = 20;
            const skip = (Math.max(1, page) - 1) * limit;
            const qb = this.ProductRepo.createQueryBuilder("product")
                .where("product.categoryId = :categoryId", { categoryId })
                .leftJoinAndSelect("product.reviews", "reviews")
                .skip(skip)
                .take(limit);
            const [products, total] = await qb.getManyAndCount();
            const totalPages = Math.max(1, Math.ceil(total / limit));
            const result = { products, currentPage: page, totalPages };
            return result;
        }
        catch (err) {
            throw new Error("Failed to fetch products by category: " + err);
        }
    }
};
exports.UserService = UserService;
exports.UserService = UserService = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, typeorm_1.InjectRepository)(User_entity_1.User)),
    __param(1, (0, typeorm_1.InjectRepository)(Cart_entity_1.Cart)),
    __param(2, (0, typeorm_1.InjectRepository)(Product_entity_1.Product)),
    __param(3, (0, typeorm_1.InjectRepository)(Review_entity_1.Review)),
    __param(4, (0, typeorm_1.InjectRepository)(Cart_Item_entity_1.CartItem)),
    __metadata("design:paramtypes", [typeof (_a = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _a : Object, typeof (_b = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _b : Object, typeof (_c = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _c : Object, typeof (_d = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _d : Object, typeof (_e = typeof typeorm_2.Repository !== "undefined" && typeorm_2.Repository) === "function" ? _e : Object])
], UserService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvb21hci9EZXNrdG9wL1Byb3RvZm9saW9fd2l0aG91dF9yZWRpcy9zcmMvdXNlci91c2VyLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUl3QjtBQUN4Qiw2Q0FBbUQ7QUFDbkQscUNBQXFDO0FBQ3JDLHlEQUErQztBQUMvQyx5REFBK0M7QUFDL0MsK0RBQXFEO0FBQ3JELDZEQUFtRDtBQUNuRCxtRUFBd0Q7QUFHakQsSUFBTSxXQUFXLEdBQWpCLE1BQU0sV0FBVztJQUdIO0lBRUE7SUFFQTtJQUVBO0lBRUE7SUFWbkIsWUFFbUIsUUFBMEIsRUFFMUIsUUFBMEIsRUFFMUIsV0FBZ0MsRUFFaEMsVUFBOEIsRUFFOUIsWUFBa0M7UUFSbEMsYUFBUSxHQUFSLFFBQVEsQ0FBa0I7UUFFMUIsYUFBUSxHQUFSLFFBQVEsQ0FBa0I7UUFFMUIsZ0JBQVcsR0FBWCxXQUFXLENBQXFCO1FBRWhDLGVBQVUsR0FBVixVQUFVLENBQW9CO1FBRTlCLGlCQUFZLEdBQVosWUFBWSxDQUFzQjtJQUNsRCxDQUFDO0lBQ0osS0FBSyxDQUFDLFVBQVUsQ0FDZCxLQUFhLEVBQ2IsT0FBZSxFQUNmLFNBQWlCLEVBQ2pCLE1BQWM7UUFFZCxNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN0RSxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxVQUFVLEtBQUssS0FBSyxFQUFFLENBQUM7WUFDdkMsTUFBTSxJQUFJLDBCQUFpQixDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDakQsQ0FBQztRQUNELE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUM7WUFDN0MsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRTtTQUN6QixDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsT0FB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LElBQUksRUFBRSxVQUFVLEVBQUUsQ0FBQztZQUMzRCxPQUFPLE1BQU0sQ0FBQztRQUNoQixDQUFDO1FBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNiLE1BQU0sSUFBSSxLQUFLLENBQUMsd0NBQXdDLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFDbEUsQ0FBQztJQUNILENBQUM7Q0FDRixDQUFBO0FBbE1ZLGtDQUFXO3NCQUFYLFdBQVc7SUFEdkIsSUFBQSxtQkFBVSxHQUFFO0lBR1IsV0FBQSxJQUFBLDBCQUFnQixFQUFDLGtCQUFJLENBQUMsQ0FBQTtJQUV0QixXQUFBLElBQUEsMEJBQWdCLEVBQUMsa0JBQUksQ0FBQyxDQUFBO0lBRXRCLFdBQUEsSUFBQSwwQkFBZ0IsRUFBQyx3QkFBTyxDQUFDLENBQUE7SUFFekIsV0FBQSxJQUFBLDBCQUFnQixFQUFDLHNCQUFNLENBQUMsQ0FBQTtJQUV4QixXQUFBLElBQUEsMEJBQWdCLEVBQUMsMkJBQVEsQ0FBQyxDQUFBO3lEQVBBLG9CQUFVLG9CQUFWLG9CQUFVLG9EQUVWLG9CQUFVLG9CQUFWLG9CQUFVLG9EQUVQLG9CQUFVLG9CQUFWLG9CQUFVLG9EQUVYLG9CQUFVLG9CQUFWLG9CQUFVLG9EQUVSLG9CQUFVLG9CQUFWLG9CQUFVO0dBWGhDLFdBQVcsQ0FrTXZCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL29tYXIvRGVza3RvcC9Qcm90b2ZvbGlvX3dpdGhvdXRfcmVkaXMvc3JjL3VzZXIvdXNlci5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEJhZFJlcXVlc3RFeGNlcHRpb24sXG4gIEluamVjdGFibGUsXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxufSBmcm9tIFwiQG5lc3Rqcy9jb21tb25cIjtcbmltcG9ydCB7IEluamVjdFJlcG9zaXRvcnkgfSBmcm9tIFwiQG5lc3Rqcy90eXBlb3JtXCI7XG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSBcInR5cGVvcm1cIjtcbmltcG9ydCB7IENhcnQgfSBmcm9tIFwiLi4vZW50aXRpZXMvQ2FydC5lbnRpdHlcIjtcbmltcG9ydCB7IFVzZXIgfSBmcm9tIFwiLi4vZW50aXRpZXMvVXNlci5lbnRpdHlcIjtcbmltcG9ydCB7IFByb2R1Y3QgfSBmcm9tIFwiLi4vZW50aXRpZXMvUHJvZHVjdC5lbnRpdHlcIjtcbmltcG9ydCB7IFJldmlldyB9IGZyb20gXCIuLi9lbnRpdGllcy9SZXZpZXcuZW50aXR5XCI7XG5pbXBvcnQgeyBDYXJ0SXRlbSB9IGZyb20gXCIuLi9lbnRpdGllcy9DYXJ0X0l0ZW0uZW50aXR5XCI7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBVc2VyU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3RSZXBvc2l0b3J5KFVzZXIpXG4gICAgcHJpdmF0ZSByZWFkb25seSBVc2VyUmVwbzogUmVwb3NpdG9yeTxVc2VyPixcbiAgICBASW5qZWN0UmVwb3NpdG9yeShDYXJ0KVxuICAgIHByaXZhdGUgcmVhZG9ubHkgQ2FydFJlcG86IFJlcG9zaXRvcnk8Q2FydD4sXG4gICAgQEluamVjdFJlcG9zaXRvcnkoUHJvZHVjdClcbiAgICBwcml2YXRlIHJlYWRvbmx5IFByb2R1Y3RSZXBvOiBSZXBvc2l0b3J5PFByb2R1Y3Q+LFxuICAgIEBJbmplY3RSZXBvc2l0b3J5KFJldmlldylcbiAgICBwcml2YXRlIHJlYWRvbmx5IFJldmlld1JlcG86IFJlcG9zaXRvcnk8UmV2aWV3PixcbiAgICBASW5qZWN0UmVwb3NpdG9yeShDYXJ0SXRlbSlcbiAgICBwcml2YXRlIHJlYWRvbmx5IENhcnRJdGVtUmVwbzogUmVwb3NpdG9yeTxDYXJ0SXRlbT4sXG4gICkge31cbiAgYXN5bmMgQWRkX1JldmlldyhcbiAgICBlbWFpbDogc3RyaW5nLFxuICAgIGNvbW1lbnQ6IHN0cmluZyxcbiAgICBwcm9kdWN0SWQ6IHN0cmluZyxcbiAgICByYXRpbmc6IG51bWJlcixcbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy5Vc2VyUmVwby5maW5kT25lKHsgd2hlcmU6IHsgZW1haWw6IGVtYWlsIH0gfSk7XG4gICAgaWYgKCF1c2VyIHx8IHVzZXIuaXNWZXJpZmllZCA9PT0gZmFsc2UpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihcImVtYWlsIG5vdCBmb3VuZFwiKTtcbiAgICB9XG4gICAgY29uc3QgcHJvZHVjdCA9IGF3YWl0IHRoaXMuUHJvZHVjdFJlcG8uZmluZE9uZSh7XG4gICAgICB3aGVyZTogeyBpZDogcHJvZHVjdElkIH0sXG4gICAgfSk7XG4gICAgaWYgKCFwcm9kdWN0KSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXCJwcm9kdWN0IG5vdCBmb3VuZFwiKTtcbiAgICB9XG4gICAgY29uc3QgcmV2aWV3ID0gdGhpcy5SZXZpZXdSZXBvLmNyZWF0ZSh7XG4gICAgICB1c2VyOiB1c2VyLFxuICAgICAgcHJvZHVjdDogcHJvZHVjdCxcbiAgICAgIGNvbW1lbnQ6IGNvbW1lbnQsXG4gICAgICByYXRpbmc6IHJhdGluZyxcbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLlJldmlld1JlcG8uc2F2ZShyZXZpZXcpO1xuICAgIHJldHVybiBcIm9rXCI7XG4gIH1cblxuICBhc3luYyBFZGl0X1JldmlldyhcbiAgICBlbWFpbDogc3RyaW5nLFxuICAgIHJldmlld0lkOiBzdHJpbmcsXG4gICAgY29tbWVudD86IHN0cmluZyxcbiAgICByYXRpbmc/OiBudW1iZXIsXG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgcmV2aWV3ID0gYXdhaXQgdGhpcy5SZXZpZXdSZXBvLmZpbmRPbmUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHJldmlld0lkIH0sXG4gICAgICByZWxhdGlvbnM6IFtcInVzZXJcIl0sXG4gICAgfSk7XG4gICAgaWYgKCFyZXZpZXcpIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihcInJldmlldyBub3QgZm91bmRcIik7XG4gICAgaWYgKCFyZXZpZXcudXNlciB8fCByZXZpZXcudXNlci5lbWFpbCAhPT0gZW1haWwpXG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXCJub3QgYXV0aG9yaXplZCBvciByZXZpZXcgbm90IGZvdW5kXCIpO1xuXG4gICAgY29uc3QgdXBkYXRlZDogUGFydGlhbDxSZXZpZXc+ID0ge307XG4gICAgaWYgKHR5cGVvZiBjb21tZW50ICE9PSBcInVuZGVmaW5lZFwiKSB1cGRhdGVkLmNvbW1lbnQgPSBjb21tZW50O1xuICAgIGlmICh0eXBlb2YgcmF0aW5nICE9PSBcInVuZGVmaW5lZFwiKSB1cGRhdGVkLnJhdGluZyA9IHJhdGluZztcblxuICAgIGF3YWl0IHRoaXMuUmV2aWV3UmVwby51cGRhdGUoeyBpZDogcmV2aWV3SWQgfSwgdXBkYXRlZCk7XG4gICAgcmV0dXJuIFwib2tcIjtcbiAgfVxuXG4gIGFzeW5jIFJlbW92ZV9SZXZpZXcoZW1haWw6IHN0cmluZywgcmV2aWV3SWQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgcmV2aWV3ID0gYXdhaXQgdGhpcy5SZXZpZXdSZXBvLmZpbmRPbmUoe1xuICAgICAgd2hlcmU6IHsgaWQ6IHJldmlld0lkIH0sXG4gICAgICByZWxhdGlvbnM6IFtcInVzZXJcIl0sXG4gICAgfSk7XG4gICAgaWYgKCFyZXZpZXcpIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihcInJldmlldyBub3QgZm91bmRcIik7XG4gICAgaWYgKCFyZXZpZXcudXNlciB8fCByZXZpZXcudXNlci5lbWFpbCAhPT0gZW1haWwpXG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXCJub3QgYXV0aG9yaXplZCBvciByZXZpZXcgbm90IGZvdW5kXCIpO1xuXG4gICAgYXdhaXQgdGhpcy5SZXZpZXdSZXBvLmRlbGV0ZSh7IGlkOiByZXZpZXdJZCB9KTtcbiAgICByZXR1cm4gXCJva1wiO1xuICB9XG4gIGFzeW5jIEFkZF9DYXJ0X0l0ZW0oY2FydElkOiBzdHJpbmcsIHByb2R1Y3RJZDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBjYXJ0ID0gYXdhaXQgdGhpcy5DYXJ0UmVwby5maW5kT25lQnkoeyBpZDogY2FydElkIH0pO1xuICAgIGlmICghY2FydCkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKFwiY2FydCBub3QgZm91bmRcIik7XG4gICAgfVxuICAgIGNvbnN0IFByb2R1Y3QgPSBhd2FpdCB0aGlzLlByb2R1Y3RSZXBvLmZpbmRPbmVCeSh7IGlkOiBwcm9kdWN0SWQgfSk7XG4gICAgaWYgKCFQcm9kdWN0KSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXCJQcm9kdWN0IG5vdCBmb3VuZFwiKTtcbiAgICB9XG4gICAgY29uc3QgY2FydEl0ZW0gPSBhd2FpdCB0aGlzLkNhcnRJdGVtUmVwby5maW5kT25lKHtcbiAgICAgIHdoZXJlOiB7IGNhcnQ6IHsgaWQ6IGNhcnRJZCB9LCBwcm9kdWN0OiB7IGlkOiBwcm9kdWN0SWQgfSB9LFxuICAgICAgcmVsYXRpb25zOiBbXCJjYXJ0XCIsIFwicHJvZHVjdFwiXSxcbiAgICB9KTtcbiAgICBpZiAoY2FydEl0ZW0pIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFwiSXRlbSBhbHJlYWR5IGluIGNhcnRcIik7XG4gICAgfVxuICAgIGNvbnN0IENhcnRfSXRlbSA9IHRoaXMuQ2FydEl0ZW1SZXBvLmNyZWF0ZSh7XG4gICAgICBxdWFudGl0eTogMSxcbiAgICAgIGNhcnQ6IGNhcnQsXG4gICAgICBwcm9kdWN0OiBQcm9kdWN0LFxuICAgIH0pO1xuICAgIGF3YWl0IHRoaXMuQ2FydEl0ZW1SZXBvLnNhdmUoQ2FydF9JdGVtKTtcbiAgICByZXR1cm4gXCJva1wiO1xuICB9XG5cbiAgYXN5bmMgUmVtb3ZlX0NhcnRfSXRlbShjYXJ0SWQ6IHN0cmluZywgcHJvZHVjdElkOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IGNhcnQgPSBhd2FpdCB0aGlzLkNhcnRSZXBvLmZpbmRPbmVCeSh7IGlkOiBjYXJ0SWQgfSk7XG4gICAgaWYgKCFjYXJ0KSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXCJjYXJ0IG5vdCBmb3VuZFwiKTtcbiAgICB9XG4gICAgY29uc3QgcHJvZHVjdCA9IGF3YWl0IHRoaXMuUHJvZHVjdFJlcG8uZmluZE9uZUJ5KHsgaWQ6IHByb2R1Y3RJZCB9KTtcbiAgICBpZiAoIXByb2R1Y3QpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihcIlByb2R1Y3Qgbm90IGZvdW5kXCIpO1xuICAgIH1cblxuICAgIGNvbnN0IGNhcnRJdGVtID0gYXdhaXQgdGhpcy5DYXJ0SXRlbVJlcG8uZmluZE9uZSh7XG4gICAgICB3aGVyZTogeyBjYXJ0OiB7IGlkOiBjYXJ0SWQgfSwgcHJvZHVjdDogeyBpZDogcHJvZHVjdElkIH0gfSxcbiAgICAgIHJlbGF0aW9uczogW1wiY2FydFwiLCBcInByb2R1Y3RcIl0sXG4gICAgfSk7XG4gICAgaWYgKCFjYXJ0SXRlbSkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKFwiY2FydCBpdGVtIG5vdCBmb3VuZFwiKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLkNhcnRJdGVtUmVwby5yZW1vdmUoY2FydEl0ZW0pO1xuICAgIHJldHVybiBcIm9rXCI7XG4gIH1cbiAgYXN5bmMgaW5jcmVhc2VfUXVhbnRpdHkoY2FydEl0ZW1JZDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBjYXJ0SXRlbSA9IGF3YWl0IHRoaXMuQ2FydEl0ZW1SZXBvLmZpbmRPbmVCeSh7IGlkOiBjYXJ0SXRlbUlkIH0pO1xuICAgIGlmICghY2FydEl0ZW0pIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihcImNhcnRJdGVtIG5vdCBmb3VuZFwiKTtcbiAgICB9XG4gICAgaWYgKGNhcnRJdGVtLnF1YW50aXR5ID49IDk5OSkge1xuICAgICAgcmV0dXJuIFwibm9cIjtcbiAgICB9XG4gICAgY2FydEl0ZW0ucXVhbnRpdHkrKztcbiAgICBhd2FpdCB0aGlzLkNhcnRJdGVtUmVwby5zYXZlKGNhcnRJdGVtKTtcbiAgICByZXR1cm4gXCJva1wiO1xuICB9XG4gIGFzeW5jIGRlY3JlYXNlX1F1YW50aXR5KGNhcnRJdGVtSWQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgY2FydEl0ZW0gPSBhd2FpdCB0aGlzLkNhcnRJdGVtUmVwby5maW5kT25lQnkoeyBpZDogY2FydEl0ZW1JZCB9KTtcbiAgICBpZiAoIWNhcnRJdGVtKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXCJjYXJ0SXRlbSBub3QgZm91bmRcIik7XG4gICAgfVxuICAgIGlmIChjYXJ0SXRlbS5xdWFudGl0eSA8PSAxKSB7XG4gICAgICByZXR1cm4gXCJub1wiO1xuICAgIH1cbiAgICBjYXJ0SXRlbS5xdWFudGl0eS0tO1xuICAgIGF3YWl0IHRoaXMuQ2FydEl0ZW1SZXBvLnNhdmUoY2FydEl0ZW0pO1xuICAgIHJldHVybiBcIm9rXCI7XG4gIH1cbiAgYXN5bmMgU2VhcmNoUHJvZHVjdHMoXG4gICAgc2VhcmNoVGVybTogc3RyaW5nLFxuICAgIHBhZ2U6IG51bWJlcixcbiAgKTogUHJvbWlzZTx7IHByb2R1Y3RzOiBQcm9kdWN0W107IGN1cnJlbnRQYWdlOiBudW1iZXI7IHRvdGFsUGFnZXM6IG51bWJlciB9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGxpbWl0ID0gMjA7XG4gICAgICBjb25zdCBza2lwID0gKE1hdGgubWF4KDEsIHBhZ2UpIC0gMSkgKiBsaW1pdDtcblxuICAgICAgY29uc3QgcWIgPSB0aGlzLlByb2R1Y3RSZXBvLmNyZWF0ZVF1ZXJ5QnVpbGRlcihcInByb2R1Y3RcIilcbiAgICAgICAgLndoZXJlKFwicHJvZHVjdC5uYW1lIExJS0UgOnNlYXJjaFRlcm1cIiwge1xuICAgICAgICAgIHNlYXJjaFRlcm06IGAlJHtzZWFyY2hUZXJtfSVgLFxuICAgICAgICB9KVxuICAgICAgICAub3JXaGVyZShcInByb2R1Y3QuZGVzY3JpcHRpb24gTElLRSA6c2VhcmNoVGVybVwiLCB7XG4gICAgICAgICAgc2VhcmNoVGVybTogYCUke3NlYXJjaFRlcm19JWAsXG4gICAgICAgIH0pXG4gICAgICAgIC5sZWZ0Sm9pbkFuZFNlbGVjdChcInByb2R1Y3QucmV2aWV3c1wiLCBcInJldmlld3NcIilcbiAgICAgICAgLnNraXAoc2tpcClcbiAgICAgICAgLnRha2UobGltaXQpO1xuXG4gICAgICBjb25zdCBbcHJvZHVjdHMsIHRvdGFsXSA9IGF3YWl0IHFiLmdldE1hbnlBbmRDb3VudCgpO1xuICAgICAgY29uc3QgdG90YWxQYWdlcyA9IE1hdGgubWF4KDEsIE1hdGguY2VpbCh0b3RhbCAvIGxpbWl0KSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IHsgcHJvZHVjdHMsIGN1cnJlbnRQYWdlOiBwYWdlLCB0b3RhbFBhZ2VzIH07XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRmFpbGVkIHRvIHNlYXJjaCBwcm9kdWN0czogXCIgKyBlcnIpO1xuICAgIH1cbiAgfVxuICBhc3luYyBGaW5kUHJvZHVjdHNCeUNhdGVnb3J5KFxuICAgIGNhdGVnb3J5SWQ6IHN0cmluZyxcbiAgICBwYWdlOiBudW1iZXIsXG4gICk6IFByb21pc2U8eyBwcm9kdWN0czogUHJvZHVjdFtdOyBjdXJyZW50UGFnZTogbnVtYmVyOyB0b3RhbFBhZ2VzOiBudW1iZXIgfT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBsaW1pdCA9IDIwO1xuICAgICAgY29uc3Qgc2tpcCA9IChNYXRoLm1heCgxLCBwYWdlKSAtIDEpICogbGltaXQ7XG5cbiAgICAgIGNvbnN0IHFiID0gdGhpcy5Qcm9kdWN0UmVwby5jcmVhdGVRdWVyeUJ1aWxkZXIoXCJwcm9kdWN0XCIpXG4gICAgICAgIC53aGVyZShcInByb2R1Y3QuY2F0ZWdvcnlJZCA9IDpjYXRlZ29yeUlkXCIsIHsgY2F0ZWdvcnlJZCB9KVxuICAgICAgICAubGVmdEpvaW5BbmRTZWxlY3QoXCJwcm9kdWN0LnJldmlld3NcIiwgXCJyZXZpZXdzXCIpXG4gICAgICAgIC5za2lwKHNraXApXG4gICAgICAgIC50YWtlKGxpbWl0KTtcblxuICAgICAgY29uc3QgW3Byb2R1Y3RzLCB0b3RhbF0gPSBhd2FpdCBxYi5nZXRNYW55QW5kQ291bnQoKTtcbiAgICAgIGNvbnN0IHRvdGFsUGFnZXMgPSBNYXRoLm1heCgxLCBNYXRoLmNlaWwodG90YWwgLyBsaW1pdCkpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSB7IHByb2R1Y3RzLCBjdXJyZW50UGFnZTogcGFnZSwgdG90YWxQYWdlcyB9O1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkZhaWxlZCB0byBmZXRjaCBwcm9kdWN0cyBieSBjYXRlZ29yeTogXCIgKyBlcnIpO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9