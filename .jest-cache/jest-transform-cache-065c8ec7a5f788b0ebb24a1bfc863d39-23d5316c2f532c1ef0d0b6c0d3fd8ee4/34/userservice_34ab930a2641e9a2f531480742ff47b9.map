{"file":"/home/omar/Desktop/Protofolio_without_redis/src/user/user.service.ts","mappings":"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","names":[],"sources":["/home/omar/Desktop/Protofolio_without_redis/src/user/user.service.ts"],"sourcesContent":["import {\n  BadRequestException,\n  Injectable,\n  NotFoundException,\n} from \"@nestjs/common\";\nimport { InjectRepository } from \"@nestjs/typeorm\";\nimport { Repository } from \"typeorm\";\nimport { Cart } from \"../entities/Cart.entity\";\nimport { User } from \"../entities/User.entity\";\nimport { Product } from \"../entities/Product.entity\";\nimport { Review } from \"../entities/Review.entity\";\nimport { CartItem } from \"../entities/Cart_Item.entity\";\n\n@Injectable()\nexport class UserService {\n  constructor(\n    @InjectRepository(User)\n    private readonly UserRepo: Repository<User>,\n    @InjectRepository(Cart)\n    private readonly CartRepo: Repository<Cart>,\n    @InjectRepository(Product)\n    private readonly ProductRepo: Repository<Product>,\n    @InjectRepository(Review)\n    private readonly ReviewRepo: Repository<Review>,\n    @InjectRepository(CartItem)\n    private readonly CartItemRepo: Repository<CartItem>,\n  ) {}\n  async Add_Review(\n    email: string,\n    comment: string,\n    productId: string,\n    rating: number,\n  ): Promise<string> {\n    const user = await this.UserRepo.findOne({ where: { email: email } });\n    if (!user || user.isVerified === false) {\n      throw new NotFoundException(\"email not found\");\n    }\n    const product = await this.ProductRepo.findOne({\n      where: { id: productId },\n    });\n    if (!product) {\n      throw new NotFoundException(\"product not found\");\n    }\n    const review = this.ReviewRepo.create({\n      user: user,\n      product: product,\n      comment: comment,\n      rating: rating,\n    });\n    await this.ReviewRepo.save(review);\n    return \"ok\";\n  }\n\n  async Edit_Review(\n    email: string,\n    reviewId: string,\n    comment?: string,\n    rating?: number,\n  ): Promise<string> {\n    const review = await this.ReviewRepo.findOne({\n      where: { id: reviewId },\n      relations: [\"user\"],\n    });\n    if (!review) throw new NotFoundException(\"review not found\");\n    if (!review.user || review.user.email !== email)\n      throw new NotFoundException(\"not authorized or review not found\");\n\n    const updated: Partial<Review> = {};\n    if (typeof comment !== \"undefined\") updated.comment = comment;\n    if (typeof rating !== \"undefined\") updated.rating = rating;\n\n    await this.ReviewRepo.update({ id: reviewId }, updated);\n    return \"ok\";\n  }\n\n  async Remove_Review(email: string, reviewId: string): Promise<string> {\n    const review = await this.ReviewRepo.findOne({\n      where: { id: reviewId },\n      relations: [\"user\"],\n    });\n    if (!review) throw new NotFoundException(\"review not found\");\n    if (!review.user || review.user.email !== email)\n      throw new NotFoundException(\"not authorized or review not found\");\n\n    await this.ReviewRepo.delete({ id: reviewId });\n    return \"ok\";\n  }\n  async Add_Cart_Item(cartId: string, productId: string): Promise<string> {\n    const cart = await this.CartRepo.findOneBy({ id: cartId });\n    if (!cart) {\n      throw new NotFoundException(\"cart not found\");\n    }\n    const Product = await this.ProductRepo.findOneBy({ id: productId });\n    if (!Product) {\n      throw new NotFoundException(\"Product not found\");\n    }\n    const cartItem = await this.CartItemRepo.findOne({\n      where: { cart: { id: cartId }, product: { id: productId } },\n      relations: [\"cart\", \"product\"],\n    });\n    if (cartItem) {\n      throw new BadRequestException(\"Item already in cart\");\n    }\n    const Cart_Item = this.CartItemRepo.create({\n      quantity: 1,\n      cart: cart,\n      product: Product,\n    });\n    await this.CartItemRepo.save(Cart_Item);\n    return \"ok\";\n  }\n\n  async Remove_Cart_Item(cartId: string, productId: string): Promise<string> {\n    const cart = await this.CartRepo.findOneBy({ id: cartId });\n    if (!cart) {\n      throw new NotFoundException(\"cart not found\");\n    }\n    const product = await this.ProductRepo.findOneBy({ id: productId });\n    if (!product) {\n      throw new NotFoundException(\"Product not found\");\n    }\n\n    const cartItem = await this.CartItemRepo.findOne({\n      where: { cart: { id: cartId }, product: { id: productId } },\n      relations: [\"cart\", \"product\"],\n    });\n    if (!cartItem) {\n      throw new NotFoundException(\"cart item not found\");\n    }\n\n    await this.CartItemRepo.remove(cartItem);\n    return \"ok\";\n  }\n  async increase_Quantity(cartItemId: string): Promise<string> {\n    const cartItem = await this.CartItemRepo.findOneBy({ id: cartItemId });\n    if (!cartItem) {\n      throw new NotFoundException(\"cartItem not found\");\n    }\n    if (cartItem.quantity >= 999) {\n      return \"no\";\n    }\n    cartItem.quantity++;\n    await this.CartItemRepo.save(cartItem);\n    return \"ok\";\n  }\n  async decrease_Quantity(cartItemId: string): Promise<string> {\n    const cartItem = await this.CartItemRepo.findOneBy({ id: cartItemId });\n    if (!cartItem) {\n      throw new NotFoundException(\"cartItem not found\");\n    }\n    if (cartItem.quantity <= 1) {\n      return \"no\";\n    }\n    cartItem.quantity--;\n    await this.CartItemRepo.save(cartItem);\n    return \"ok\";\n  }\n  async SearchProducts(\n    searchTerm: string,\n    page: number,\n  ): Promise<{ products: Product[]; currentPage: number; totalPages: number }> {\n    try {\n      const limit = 20;\n      const skip = (Math.max(1, page) - 1) * limit;\n\n      const qb = this.ProductRepo.createQueryBuilder(\"product\")\n        .where(\"product.name LIKE :searchTerm\", {\n          searchTerm: `%${searchTerm}%`,\n        })\n        .orWhere(\"product.description LIKE :searchTerm\", {\n          searchTerm: `%${searchTerm}%`,\n        })\n        .leftJoinAndSelect(\"product.reviews\", \"reviews\")\n        .skip(skip)\n        .take(limit);\n\n      const [products, total] = await qb.getManyAndCount();\n      const totalPages = Math.max(1, Math.ceil(total / limit));\n\n      const result = { products, currentPage: page, totalPages };\n      return result;\n    } catch (err) {\n      throw new Error(\"Failed to search products: \" + err);\n    }\n  }\n  async FindProductsByCategory(\n    categoryId: string,\n    page: number,\n  ): Promise<{ products: Product[]; currentPage: number; totalPages: number }> {\n    try {\n      const limit = 20;\n      const skip = (Math.max(1, page) - 1) * limit;\n\n      const qb = this.ProductRepo.createQueryBuilder(\"product\")\n        .where(\"product.categoryId = :categoryId\", { categoryId })\n        .leftJoinAndSelect(\"product.reviews\", \"reviews\")\n        .skip(skip)\n        .take(limit);\n\n      const [products, total] = await qb.getManyAndCount();\n      const totalPages = Math.max(1, Math.ceil(total / limit));\n\n      const result = { products, currentPage: page, totalPages };\n      return result;\n    } catch (err) {\n      throw new Error(\"Failed to fetch products by category: \" + err);\n    }\n  }\n}\n"],"version":3}