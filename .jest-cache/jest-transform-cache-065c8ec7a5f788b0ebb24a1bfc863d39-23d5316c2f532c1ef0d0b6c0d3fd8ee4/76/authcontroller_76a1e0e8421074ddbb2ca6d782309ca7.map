{"file":"/home/omar/Desktop/Protofolio_without_redis/src/auth/auth.controller.ts","mappings":"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","names":[],"sources":["/home/omar/Desktop/Protofolio_without_redis/src/auth/auth.controller.ts"],"sourcesContent":["import {\n  Body,\n  Controller,\n  Post,\n  Req,\n  Get,\n  UseGuards,\n  NotFoundException,\n  Res,\n} from \"@nestjs/common\";\nimport type { Request, Response } from \"express\";\nimport { AuthService } from \"./auth.service\";\nimport { AuthGuard } from \"@nestjs/passport\";\nimport {\n  RegisterHalfDto,\n  RegisterCompleteDto,\n  RegisterFullDto,\n  LoginDto,\n  PasswordResetRequestDto,\n  PasswordResetConfirmDto,\n  LogOutDto,\n} from \"./Dto/main_auth.dto\";\nimport { GoogleProfile } from \"./GoogleProfile\";\nimport { Cookies } from \"./Cookies\";\nimport { ThrottlerGuard } from \"@nestjs/throttler\";\nimport { ApiResponse } from \"../common/dto/response.dto\";\nimport { ConfigService } from \"@nestjs/config\";\n\n@UseGuards(ThrottlerGuard)\n@Controller(\"auth\")\nexport class AuthController {\n  constructor(\n    private readonly authService: AuthService,\n    private readonly configService: ConfigService,\n  ) {}\n\n  @Post(\"half-register\")\n  async register_half(@Body() dto: RegisterHalfDto, @Req() req: Request) {\n    const ipAddress = req.ip || req.socket.remoteAddress || \"unknown\";\n    const result = await this.authService.register_half(dto.email, ipAddress);\n    return result;\n  }\n  @Post(\"full_register\")\n  async register_full(@Body() dto: RegisterFullDto, @Req() req: Request) {\n    const ipAddress = req.ip || req.socket.remoteAddress || \"unknown\";\n    const result = await this.authService.register_full(\n      dto.email,\n      dto.code,\n      ipAddress,\n    );\n    return result;\n  }\n  @Post(\"complete_register\")\n  async register_complete(\n    @Body() dto: RegisterCompleteDto,\n    @Res() res: Response,\n  ) {\n    const result = await this.authService.register_complete(\n      dto.email,\n      dto.password,\n    );\n    const refresh_Token = result.refresh_Token;\n    if (!refresh_Token) throw new NotFoundException(\"refresh_token not found\");\n    const access_token = result.access_token;\n    if (!access_token) throw new NotFoundException(\"access token not found\");\n    res.cookie(\"refreshToken\", refresh_Token, {\n      httpOnly: false,\n      secure: true,\n      sameSite: \"strict\",\n      path: \"/update_token\",\n      maxAge: 7 * 24 * 60 * 60 * 1000,\n    });\n    return res.json(\n      ApiResponse.success(\"success\", {\n        access_token: access_token,\n      }),\n    );\n  }\n  @Post(\"login\")\n  async login(\n    @Body() dto: LoginDto,\n    @Req() req: Request,\n    @Res() res: Response,\n  ) {\n    const ipAddress = req.ip || req.socket.remoteAddress || \"unknown\";\n    const result = await this.authService.login(\n      dto.email,\n      dto.password,\n      ipAddress,\n    );\n    const refresh_Token = result.refresh_Token;\n    if (!refresh_Token) throw new NotFoundException(\"refersh_token not found\");\n    const access_token = result.access_token;\n    if (!access_token) throw new NotFoundException(\"not found access token\");\n    const ismatch = this.configService.get(\"NODE_ENV\") === \"production\";\n    res.cookie(\"refreshToken\", refresh_Token, {\n      httpOnly: false,\n      secure: ismatch,\n      sameSite: \"strict\",\n      path: \"/update_token\",\n      maxAge: 7 * 24 * 60 * 60 * 1000,\n    });\n    return res.json(\n      ApiResponse.success(\"success\", {\n        access_token,\n      }),\n    );\n  }\n\n  // هنا التوكن هيتمسح بس في الفرونت اند اما في السيرفر مش عارف ايه الطريقه الآمنه الامسح بيها اي توكن\n  @Post(\"log_out\")\n  log_out(@Body() dto: LogOutDto) {\n    return this.authService.log_out(dto.email, dto.refresh_token);\n  }\n\n  @Post(\"password-reset-request\")\n  async requestPasswordReset(@Body() dto: PasswordResetRequestDto) {\n    return await this.authService.requestPasswordReset(dto.email);\n  }\n\n  @Post(\"password-reset-confirm\")\n  async confirmPasswordReset(@Body() dto: PasswordResetConfirmDto) {\n    return await this.authService.confirmPasswordReset(\n      dto.email,\n      dto.token,\n      dto.newPassword,\n    );\n  }\n\n  @Get(\"callback/google\")\n  @UseGuards(AuthGuard(\"google\"))\n  async googleCallback(\n    @Req() req: Request & { user: GoogleProfile },\n    @Res() res: Response,\n  ) {\n    const profile = {\n      id: req.user.id,\n      emails: req.user.emails,\n      displayName: req.user.displayName,\n      photos: req.user.photos,\n      provider: req.user.provider,\n    };\n\n    const google = await this.authService.validateGoogleUser(profile);\n    const refresh_Token = google.refresh_Token;\n    if (!refresh_Token) throw new NotFoundException(\"not found refresh token\");\n    const access_token = google.token;\n    if (!access_token) throw new NotFoundException(\"not found access token\");\n    const user = google.user;\n    if (!user) throw new NotFoundException(\"user not found\");\n    const ismatch = this.configService.get(\"NODE_ENV\") === \"production\";\n    res.cookie(\"refreshToken\", refresh_Token, {\n      httpOnly: false,\n      secure: ismatch,\n      sameSite: \"strict\",\n      path: \"/update_token\",\n      maxAge: 7 * 24 * 60 * 60 * 1000,\n    });\n    return res.json(ApiResponse.success(\"success\", { user, access_token }));\n  }\n  @Post(\"update_token\")\n  async update_token(\n    @Body(\"email\") email: string,\n    @Req() req: Request,\n  ): Promise<ApiResponse<{ access_token: string }>> {\n    const cookies = req.cookies as Cookies;\n    const refresh_Token = cookies.refresh_Token;\n\n    if (!refresh_Token) {\n      throw new NotFoundException(\"no refresh Token\");\n    }\n    const access_token = await this.authService.update_token(\n      email,\n      refresh_Token,\n    );\n    return ApiResponse.success(\"Token refreshed successfully\", {\n      access_token: access_token.access_token,\n    });\n  }\n  @Get(\"csrf\")\n  getCsrfToken(@Req() req: Request) {\n    return { csrfToken: req.csrfToken?.() };\n  }\n}\n"],"version":3}