f0ee9fe2d56c6d0594910e261cc1c134
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuthController = void 0;
const common_1 = require("@nestjs/common");
const auth_service_1 = require("./auth.service");
const passport_1 = require("@nestjs/passport");
const main_auth_dto_1 = require("./Dto/main_auth.dto");
const throttler_1 = require("@nestjs/throttler");
const response_dto_1 = require("../common/dto/response.dto");
const config_1 = require("@nestjs/config");
let AuthController = class AuthController {
    authService;
    configService;
    constructor(authService, configService) {
        this.authService = authService;
        this.configService = configService;
    }
    async register_half(dto, req) {
        const ipAddress = req.ip || req.socket.remoteAddress || "unknown";
        const result = await this.authService.register_half(dto.email, ipAddress);
        return result;
    }
    async register_full(dto, req) {
        const ipAddress = req.ip || req.socket.remoteAddress || "unknown";
        const result = await this.authService.register_full(dto.email, dto.code, ipAddress);
        return result;
    }
    async register_complete(dto, res) {
        const result = await this.authService.register_complete(dto.email, dto.password);
        const refresh_Token = result.refresh_Token;
        if (!refresh_Token)
            throw new common_1.NotFoundException("refresh_token not found");
        const access_token = result.access_token;
        if (!access_token)
            throw new common_1.NotFoundException("access token not found");
        res.cookie("refreshToken", refresh_Token, {
            httpOnly: false,
            secure: true,
            sameSite: "strict",
            path: "/update_token",
            maxAge: 7 * 24 * 60 * 60 * 1000,
        });
        return res.json(response_dto_1.ApiResponse.success("success", {
            access_token: access_token,
        }));
    }
    async login(dto, req, res) {
        const ipAddress = req.ip || req.socket.remoteAddress || "unknown";
        const result = await this.authService.login(dto.email, dto.password, ipAddress);
        const refresh_Token = result.refresh_Token;
        if (!refresh_Token)
            throw new common_1.NotFoundException("refersh_token not found");
        const access_token = result.access_token;
        if (!access_token)
            throw new common_1.NotFoundException("not found access token");
        const ismatch = this.configService.get("NODE_ENV") === "production";
        res.cookie("refreshToken", refresh_Token, {
            httpOnly: false,
            secure: ismatch,
            sameSite: "strict",
            path: "/update_token",
            maxAge: 7 * 24 * 60 * 60 * 1000,
        });
        return res.json(response_dto_1.ApiResponse.success("success", {
            access_token,
        }));
    }
    // هنا التوكن هيتمسح بس في الفرونت اند اما في السيرفر مش عارف ايه الطريقه الآمنه الامسح بيها اي توكن
    log_out(dto) {
        return this.authService.log_out(dto.email, dto.refresh_token);
    }
    async requestPasswordReset(dto) {
        return await this.authService.requestPasswordReset(dto.email);
    }
    async confirmPasswordReset(dto) {
        return await this.authService.confirmPasswordReset(dto.email, dto.token, dto.newPassword);
    }
    async googleCallback(req, res) {
        const profile = {
            id: req.user.id,
            emails: req.user.emails,
            displayName: req.user.displayName,
            photos: req.user.photos,
            provider: req.user.provider,
        };
        const google = await this.authService.validateGoogleUser(profile);
        const refresh_Token = google.refresh_Token;
        if (!refresh_Token)
            throw new common_1.NotFoundException("not found refresh token");
        const access_token = google.token;
        if (!access_token)
            throw new common_1.NotFoundException("not found access token");
        const user = google.user;
        if (!user)
            throw new common_1.NotFoundException("user not found");
        const ismatch = this.configService.get("NODE_ENV") === "production";
        res.cookie("refreshToken", refresh_Token, {
            httpOnly: false,
            secure: ismatch,
            sameSite: "strict",
            path: "/update_token",
            maxAge: 7 * 24 * 60 * 60 * 1000,
        });
        return res.json(response_dto_1.ApiResponse.success("success", { user, access_token }));
    }
    async update_token(email, req) {
        const cookies = req.cookies;
        const refresh_Token = cookies.refresh_Token;
        if (!refresh_Token) {
            throw new common_1.NotFoundException("no refresh Token");
        }
        const access_token = await this.authService.update_token(email, refresh_Token);
        return response_dto_1.ApiResponse.success("Token refreshed successfully", {
            access_token: access_token.access_token,
        });
    }
    getCsrfToken(req) {
        return { csrfToken: req.csrfToken?.() };
    }
};
exports.AuthController = AuthController;
__decorate([
    (0, common_1.Post)("half-register"),
    __param(0, (0, common_1.Body)()),
    __param(1, (0, common_1.Req)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_c = typeof main_auth_dto_1.RegisterHalfDto !== "undefined" && main_auth_dto_1.RegisterHalfDto) === "function" ? _c : Object, Object]),
    __metadata("design:returntype", Promise)
], AuthController.prototype, "register_half", null);
__decorate([
    (0, common_1.Post)("full_register"),
    __param(0, (0, common_1.Body)()),
    __param(1, (0, common_1.Req)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_d = typeof main_auth_dto_1.RegisterFullDto !== "undefined" && main_auth_dto_1.RegisterFullDto) === "function" ? _d : Object, Object]),
    __metadata("design:returntype", Promise)
], AuthController.prototype, "register_full", null);
__decorate([
    (0, common_1.Post)("complete_register"),
    __param(0, (0, common_1.Body)()),
    __param(1, (0, common_1.Res)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_e = typeof main_auth_dto_1.RegisterCompleteDto !== "undefined" && main_auth_dto_1.RegisterCompleteDto) === "function" ? _e : Object, Object]),
    __metadata("design:returntype", Promise)
], AuthController.prototype, "register_complete", null);
__decorate([
    (0, common_1.Post)("login"),
    __param(0, (0, common_1.Body)()),
    __param(1, (0, common_1.Req)()),
    __param(2, (0, common_1.Res)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_f = typeof main_auth_dto_1.LoginDto !== "undefined" && main_auth_dto_1.LoginDto) === "function" ? _f : Object, Object, Object]),
    __metadata("design:returntype", Promise)
], AuthController.prototype, "login", null);
__decorate([
    (0, common_1.Post)("log_out"),
    __param(0, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_g = typeof main_auth_dto_1.LogOutDto !== "undefined" && main_auth_dto_1.LogOutDto) === "function" ? _g : Object]),
    __metadata("design:returntype", void 0)
], AuthController.prototype, "log_out", null);
__decorate([
    (0, common_1.Post)("password-reset-request"),
    __param(0, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_h = typeof main_auth_dto_1.PasswordResetRequestDto !== "undefined" && main_auth_dto_1.PasswordResetRequestDto) === "function" ? _h : Object]),
    __metadata("design:returntype", Promise)
], AuthController.prototype, "requestPasswordReset", null);
__decorate([
    (0, common_1.Post)("password-reset-confirm"),
    __param(0, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [typeof (_j = typeof main_auth_dto_1.PasswordResetConfirmDto !== "undefined" && main_auth_dto_1.PasswordResetConfirmDto) === "function" ? _j : Object]),
    __metadata("design:returntype", Promise)
], AuthController.prototype, "confirmPasswordReset", null);
__decorate([
    (0, common_1.Get)("callback/google"),
    (0, common_1.UseGuards)((0, passport_1.AuthGuard)("google")),
    __param(0, (0, common_1.Req)()),
    __param(1, (0, common_1.Res)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object, Object]),
    __metadata("design:returntype", Promise)
], AuthController.prototype, "googleCallback", null);
__decorate([
    (0, common_1.Post)("update_token"),
    __param(0, (0, common_1.Body)("email")),
    __param(1, (0, common_1.Req)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [String, Object]),
    __metadata("design:returntype", typeof (_k = typeof Promise !== "undefined" && Promise) === "function" ? _k : Object)
], AuthController.prototype, "update_token", null);
__decorate([
    (0, common_1.Get)("csrf"),
    __param(0, (0, common_1.Req)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", void 0)
], AuthController.prototype, "getCsrfToken", null);
exports.AuthController = AuthController = __decorate([
    (0, common_1.UseGuards)(throttler_1.ThrottlerGuard),
    (0, common_1.Controller)("auth"),
    __metadata("design:paramtypes", [typeof (_a = typeof auth_service_1.AuthService !== "undefined" && auth_service_1.AuthService) === "function" ? _a : Object, typeof (_b = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _b : Object])
], AuthController);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvb21hci9EZXNrdG9wL1Byb3RvZm9saW9fd2l0aG91dF9yZWRpcy9zcmMvYXV0aC9hdXRoLmNvbnRyb2xsZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQVN3QjtBQUV4QixpREFBNkM7QUFDN0MsK0NBQTZDO0FBQzdDLHVEQVE2QjtBQUc3QixpREFBbUQ7QUFDbkQsNkRBQXlEO0FBQ3pELDJDQUErQztBQUl4QyxJQUFNLGNBQWMsR0FBcEIsTUFBTSxjQUFjO0lBRU47SUFDQTtJQUZuQixZQUNtQixXQUF3QixFQUN4QixhQUE0QjtRQUQ1QixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtJQUM1QyxDQUFDO0lBR0UsQUFBTixLQUFLLENBQUMsYUFBYSxDQUFTLEdBQW9CLEVBQVMsR0FBWTtRQUNuRSxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsYUFBYSxJQUFJLFNBQVMsQ0FBQztRQUNsRSxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDMUUsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVLLEFBQU4sS0FBSyxDQUFDLGFBQWEsQ0FBUyxHQUFvQixFQUFTLEdBQVk7UUFDbkUsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDLEVBQUUsSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLGFBQWEsSUFBSSxTQUFTLENBQUM7UUFDbEUsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FDakQsR0FBRyxDQUFDLEtBQUssRUFDVCxHQUFHLENBQUMsSUFBSSxFQUNSLFNBQVMsQ0FDVixDQUFDO1FBQ0YsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVLLEFBQU4sS0FBSyxDQUFDLGlCQUFpQixDQUNiLEdBQXdCLEVBQ3pC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TCxJQUFBLGFBQUksRUFBQyxjQUFjLENBQUM7SUFFbEIsV0FBQSxJQUFBLGFBQUksRUFBQyxPQUFPLENBQUMsQ0FBQTtJQUNiLFdBQUEsSUFBQSxZQUFHLEdBQUUsQ0FBQTs7O3dEQUNMLE9BQU8sb0JBQVAsT0FBTztrREFjVDtBQUVEO0lBREMsSUFBQSxZQUFHLEVBQUMsTUFBTSxDQUFDO0lBQ0UsV0FBQSxJQUFBLFlBQUcsR0FBRSxDQUFBOzs7O2tEQUVsQjt5QkF4SlUsY0FBYztJQUYxQixJQUFBLGtCQUFTLEVBQUMsMEJBQWMsQ0FBQztJQUN6QixJQUFBLG1CQUFVLEVBQUMsTUFBTSxDQUFDO3lEQUdlLDBCQUFXLG9CQUFYLDBCQUFXLG9EQUNULHNCQUFhLG9CQUFiLHNCQUFhO0dBSHBDLGNBQWMsQ0F5SjFCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL29tYXIvRGVza3RvcC9Qcm90b2ZvbGlvX3dpdGhvdXRfcmVkaXMvc3JjL2F1dGgvYXV0aC5jb250cm9sbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEJvZHksXG4gIENvbnRyb2xsZXIsXG4gIFBvc3QsXG4gIFJlcSxcbiAgR2V0LFxuICBVc2VHdWFyZHMsXG4gIE5vdEZvdW5kRXhjZXB0aW9uLFxuICBSZXMsXG59IGZyb20gXCJAbmVzdGpzL2NvbW1vblwiO1xuaW1wb3J0IHR5cGUgeyBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gXCJleHByZXNzXCI7XG5pbXBvcnQgeyBBdXRoU2VydmljZSB9IGZyb20gXCIuL2F1dGguc2VydmljZVwiO1xuaW1wb3J0IHsgQXV0aEd1YXJkIH0gZnJvbSBcIkBuZXN0anMvcGFzc3BvcnRcIjtcbmltcG9ydCB7XG4gIFJlZ2lzdGVySGFsZkR0byxcbiAgUmVnaXN0ZXJDb21wbGV0ZUR0byxcbiAgUmVnaXN0ZXJGdWxsRHRvLFxuICBMb2dpbkR0byxcbiAgUGFzc3dvcmRSZXNldFJlcXVlc3REdG8sXG4gIFBhc3N3b3JkUmVzZXRDb25maXJtRHRvLFxuICBMb2dPdXREdG8sXG59IGZyb20gXCIuL0R0by9tYWluX2F1dGguZHRvXCI7XG5pbXBvcnQgeyBHb29nbGVQcm9maWxlIH0gZnJvbSBcIi4vR29vZ2xlUHJvZmlsZVwiO1xuaW1wb3J0IHsgQ29va2llcyB9IGZyb20gXCIuL0Nvb2tpZXNcIjtcbmltcG9ydCB7IFRocm90dGxlckd1YXJkIH0gZnJvbSBcIkBuZXN0anMvdGhyb3R0bGVyXCI7XG5pbXBvcnQgeyBBcGlSZXNwb25zZSB9IGZyb20gXCIuLi9jb21tb24vZHRvL3Jlc3BvbnNlLmR0b1wiO1xuaW1wb3J0IHsgQ29uZmlnU2VydmljZSB9IGZyb20gXCJAbmVzdGpzL2NvbmZpZ1wiO1xuXG5AVXNlR3VhcmRzKFRocm90dGxlckd1YXJkKVxuQENvbnRyb2xsZXIoXCJhdXRoXCIpXG5leHBvcnQgY2xhc3MgQXV0aENvbnRyb2xsZXIge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGF1dGhTZXJ2aWNlOiBBdXRoU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2UsXG4gICkge31cblxuICBAUG9zdChcImhhbGYtcmVnaXN0ZXJcIilcbiAgYXN5bmMgcmVnaXN0ZXJfaGFsZihAQm9keSgpIGR0bzogUmVnaXN0ZXJIYWxmRHRvLCBAUmVxKCkgcmVxOiBSZXF1ZXN0KSB7XG4gICAgY29uc3QgaXBBZGRyZXNzID0gcmVxLmlwIHx8IHJlcS5zb2NrZXQucmVtb3RlQWRkcmVzcyB8fCBcInVua25vd25cIjtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmF1dGhTZXJ2aWNlLnJlZ2lzdGVyX2hhbGYoZHRvLmVtYWlsLCBpcEFkZHJlc3MpO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbiAgQFBvc3QoXCJmdWxsX3JlZ2lzdGVyXCIpXG4gIGFzeW5jIHJlZ2lzdGVyX2Z1bGwoQEJvZHkoKSBkdG86IFJlZ2lzdGVyRnVsbER0bywgQFJlcSgpIHJlcTogUmVxdWVzdCkge1xuICAgIGNvbnN0IGlwQWRkcmVzcyA9IHJlcS5pcCB8fCByZXEuc29ja2V0LnJlbW90ZUFkZHJlc3MgfHwgXCJ1bmtub3duXCI7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5hdXRoU2VydmljZS5yZWdpc3Rlcl9mdWxsKFxuICAgICAgZHRvLmVtYWlsLFxuICAgICAgZHRvLmNvZGUsXG4gICAgICBpcEFkZHJlc3MsXG4gICAgKTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG4gIEBQb3N0KFwiY29tcGxldGVfcmVnaXN0ZXJcIilcbiAgYXN5bmMgcmVnaXN0ZXJfY29tcGxldGUoXG4gICAgQEJvZHkoKSBkdG86IFJlZ2lzdGVyQ29tcGxldGVEdG8sXG4gICAgQFJlcygpIHJlczogUmVzcG9uc2UsXG4gICkge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuYXV0aFNlcnZpY2UucmVnaXN0ZXJfY29tcGxldGUoXG4gICAgICBkdG8uZW1haWwsXG4gICAgICBkdG8ucGFzc3dvcmQsXG4gICAgKTtcbiAgICBjb25zdCByZWZyZXNoX1Rva2VuID0gcmVzdWx0LnJlZnJlc2hfVG9rZW47XG4gICAgaWYgKCFyZWZyZXNoX1Rva2VuKSB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXCJyZWZyZXNoX3Rva2VuIG5vdCBmb3VuZFwiKTtcbiAgICBjb25zdCBhY2Nlc3NfdG9rZW4gPSByZXN1bHQuYWNjZXNzX3Rva2VuO1xuICAgIGlmICghYWNjZXNzX3Rva2VuKSB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXCJhY2Nlc3MgdG9rZW4gbm90IGZvdW5kXCIpO1xuICAgIHJlcy5jb29raWUoXCJyZWZyZXNoVG9rZW5cIiwgcmVmcmVzaF9Ub2tlbiwge1xuICAgICAgaHR0cE9ubHk6IGZhbHNlLFxuICAgICAgc2VjdXJlOiB0cnVlLFxuICAgICAgc2FtZVNpdGU6IFwic3RyaWN0XCIsXG4gICAgICBwYXRoOiBcIi91cGRhdGVfdG9rZW5cIixcbiAgICAgIG1heEFnZTogNyAqIDI0ICogNjAgKiA2MCAqIDEwMDAsXG4gICAgfSk7XG4gICAgcmV0dXJuIHJlcy5qc29uKFxuICAgICAgQXBpUmVzcG9uc2Uuc3VjY2VzcyhcInN1Y2Nlc3NcIiwge1xuICAgICAgICBhY2Nlc3NfdG9rZW46IGFjY2Vzc190b2tlbixcbiAgICAgIH0pLFxuICAgICk7XG4gIH1cbiAgQFBvc3QoXCJsb2dpblwiKVxuICBhc3luYyBsb2dpbihcbiAgICBAQm9keSgpIGR0bzogTG9naW5EdG8sXG4gICAgQFJlcSgpIHJlcTogUmVxdWVzdCxcbiAgICBAUmVzKCkgcmVzOiBSZXNwb25zZSxcbiAgKSB7XG4gICAgY29uc3QgaXBBZGRyZXNzID0gcmVxLmlwIHx8IHJlcS5zb2NrZXQucmVtb3RlQWRkcmVzcyB8fCBcInVua25vd25cIjtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmF1dGhTZXJ2aWNlLmxvZ2luKFxuICAgICAgZHRvLmVtYWlsLFxuICAgICAgZHRvLnBhc3N3b3JkLFxuICAgICAgaXBBZGRyZXNzLFxuICAgICk7XG4gICAgY29uc3QgcmVmcmVzaF9Ub2tlbiA9IHJlc3VsdC5yZWZyZXNoX1Rva2VuO1xuICAgIGlmICghcmVmcmVzaF9Ub2tlbikgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKFwicmVmZXJzaF90b2tlbiBub3QgZm91bmRcIik7XG4gICAgY29uc3QgYWNjZXNzX3Rva2VuID0gcmVzdWx0LmFjY2Vzc190b2tlbjtcbiAgICBpZiAoIWFjY2Vzc190b2tlbikgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKFwibm90IGZvdW5kIGFjY2VzcyB0b2tlblwiKTtcbiAgICBjb25zdCBpc21hdGNoID0gdGhpcy5jb25maWdTZXJ2aWNlLmdldChcIk5PREVfRU5WXCIpID09PSBcInByb2R1Y3Rpb25cIjtcbiAgICByZXMuY29va2llKFwicmVmcmVzaFRva2VuXCIsIHJlZnJlc2hfVG9rZW4sIHtcbiAgICAgIGh0dHBPbmx5OiBmYWxzZSxcbiAgICAgIHNlY3VyZTogaXNtYXRjaCxcbiAgICAgIHNhbWVTaXRlOiBcInN0cmljdFwiLFxuICAgICAgcGF0aDogXCIvdXBkYXRlX3Rva2VuXCIsXG4gICAgICBtYXhBZ2U6IDcgKiAyNCAqIDYwICogNjAgKiAxMDAwLFxuICAgIH0pO1xuICAgIHJldHVybiByZXMuanNvbihcbiAgICAgIEFwaVJlc3BvbnNlLnN1Y2Nlc3MoXCJzdWNjZXNzXCIsIHtcbiAgICAgICAgYWNjZXNzX3Rva2VuLFxuICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIC8vINmH2YbYpyDYp9mE2KrZiNmD2YYg2YfZitiq2YXYs9itINio2LMg2YHZiiDYp9mE2YHYsdmI2YbYqiDYp9mG2K8g2KfZhdinINmB2Yog2KfZhNiz2YrYsdmB2LEg2YXYtCDYudin2LHZgSDYp9mK2Ycg2KfZhNi32LHZitmC2Ycg2KfZhNii2YXZhtmHINin2YTYp9mF2LPYrSDYqNmK2YfYpyDYp9mKINiq2YjZg9mGXG4gIEBQb3N0KFwibG9nX291dFwiKVxuICBsb2dfb3V0KEBCb2R5KCkgZHRvOiBMb2dPdXREdG8pIHtcbiAgICByZXR1cm4gdGhpcy5hdXRoU2VydmljZS5sb2dfb3V0KGR0by5lbWFpbCwgZHRvLnJlZnJlc2hfdG9rZW4pO1xuICB9XG5cbiAgQFBvc3QoXCJwYXNzd29yZC1yZXNldC1yZXF1ZXN0XCIpXG4gIGFzeW5jIHJlcXVlc3RQYXNzd29yZFJlc2V0KEBCb2R5KCkgZHRvOiBQYXNzd29yZFJlc2V0UmVxdWVzdER0bykge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmF1dGhTZXJ2aWNlLnJlcXVlc3RQYXNzd29yZFJlc2V0KGR0by5lbWFpbCk7XG4gIH1cblxuICBAUG9zdChcInBhc3N3b3JkLXJlc2V0LWNvbmZpcm1cIilcbiAgYXN5bmMgY29uZmlybVBhc3N3b3JkUmVzZXQoQEJvZHkoKSBkdG86IFBhc3N3b3JkUmVzZXRDb25maXJtRHRvKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuYXV0aFNlcnZpY2UuY29uZmlybVBhc3N3b3JkUmVzZXQoXG4gICAgICBkdG8uZW1haWwsXG4gICAgICBkdG8udG9rZW4sXG4gICAgICBkdG8ubmV3UGFzc3dvcmQsXG4gICAgKTtcbiAgfVxuXG4gIEBHZXQoXCJjYWxsYmFjay9nb29nbGVcIilcbiAgQFVzZUd1YXJkcyhBdXRoR3VhcmQoXCJnb29nbGVcIikpXG4gIGFzeW5jIGdvb2dsZUNhbGxiYWNrKFxuICAgIEBSZXEoKSByZXE6IFJlcXVlc3QgJiB7IHVzZXI6IEdvb2dsZVByb2ZpbGUgfSxcbiAgICBAUmVzKCkgcmVzOiBSZXNwb25zZSxcbiAgKSB7XG4gICAgY29uc3QgcHJvZmlsZSA9IHtcbiAgICAgIGlkOiByZXEudXNlci5pZCxcbiAgICAgIGVtYWlsczogcmVxLnVzZXIuZW1haWxzLFxuICAgICAgZGlzcGxheU5hbWU6IHJlcS51c2VyLmRpc3BsYXlOYW1lLFxuICAgICAgcGhvdG9zOiByZXEudXNlci5waG90b3MsXG4gICAgICBwcm92aWRlcjogcmVxLnVzZXIucHJvdmlkZXIsXG4gICAgfTtcblxuICAgIGNvbnN0IGdvb2dsZSA9IGF3YWl0IHRoaXMuYXV0aFNlcnZpY2UudmFsaWRhdGVHb29nbGVVc2VyKHByb2ZpbGUpO1xuICAgIGNvbnN0IHJlZnJlc2hfVG9rZW4gPSBnb29nbGUucmVmcmVzaF9Ub2tlbjtcbiAgICBpZiAoIXJlZnJlc2hfVG9rZW4pIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbihcIm5vdCBmb3VuZCByZWZyZXNoIHRva2VuXCIpO1xuICAgIGNvbnN0IGFjY2Vzc190b2tlbiA9IGdvb2dsZS50b2tlbjtcbiAgICBpZiAoIWFjY2Vzc190b2tlbikgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKFwibm90IGZvdW5kIGFjY2VzcyB0b2tlblwiKTtcbiAgICBjb25zdCB1c2VyID0gZ29vZ2xlLnVzZXI7XG4gICAgaWYgKCF1c2VyKSB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXCJ1c2VyIG5vdCBmb3VuZFwiKTtcbiAgICBjb25zdCBpc21hdGNoID0gdGhpcy5jb25maWdTZXJ2aWNlLmdldChcIk5PREVfRU5WXCIpID09PSBcInByb2R1Y3Rpb25cIjtcbiAgICByZXMuY29va2llKFwicmVmcmVzaFRva2VuXCIsIHJlZnJlc2hfVG9rZW4sIHtcbiAgICAgIGh0dHBPbmx5OiBmYWxzZSxcbiAgICAgIHNlY3VyZTogaXNtYXRjaCxcbiAgICAgIHNhbWVTaXRlOiBcInN0cmljdFwiLFxuICAgICAgcGF0aDogXCIvdXBkYXRlX3Rva2VuXCIsXG4gICAgICBtYXhBZ2U6IDcgKiAyNCAqIDYwICogNjAgKiAxMDAwLFxuICAgIH0pO1xuICAgIHJldHVybiByZXMuanNvbihBcGlSZXNwb25zZS5zdWNjZXNzKFwic3VjY2Vzc1wiLCB7IHVzZXIsIGFjY2Vzc190b2tlbiB9KSk7XG4gIH1cbiAgQFBvc3QoXCJ1cGRhdGVfdG9rZW5cIilcbiAgYXN5bmMgdXBkYXRlX3Rva2VuKFxuICAgIEBCb2R5KFwiZW1haWxcIikgZW1haWw6IHN0cmluZyxcbiAgICBAUmVxKCkgcmVxOiBSZXF1ZXN0LFxuICApOiBQcm9taXNlPEFwaVJlc3BvbnNlPHsgYWNjZXNzX3Rva2VuOiBzdHJpbmcgfT4+IHtcbiAgICBjb25zdCBjb29raWVzID0gcmVxLmNvb2tpZXMgYXMgQ29va2llcztcbiAgICBjb25zdCByZWZyZXNoX1Rva2VuID0gY29va2llcy5yZWZyZXNoX1Rva2VuO1xuXG4gICAgaWYgKCFyZWZyZXNoX1Rva2VuKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oXCJubyByZWZyZXNoIFRva2VuXCIpO1xuICAgIH1cbiAgICBjb25zdCBhY2Nlc3NfdG9rZW4gPSBhd2FpdCB0aGlzLmF1dGhTZXJ2aWNlLnVwZGF0ZV90b2tlbihcbiAgICAgIGVtYWlsLFxuICAgICAgcmVmcmVzaF9Ub2tlbixcbiAgICApO1xuICAgIHJldHVybiBBcGlSZXNwb25zZS5zdWNjZXNzKFwiVG9rZW4gcmVmcmVzaGVkIHN1Y2Nlc3NmdWxseVwiLCB7XG4gICAgICBhY2Nlc3NfdG9rZW46IGFjY2Vzc190b2tlbi5hY2Nlc3NfdG9rZW4sXG4gICAgfSk7XG4gIH1cbiAgQEdldChcImNzcmZcIilcbiAgZ2V0Q3NyZlRva2VuKEBSZXEoKSByZXE6IFJlcXVlc3QpIHtcbiAgICByZXR1cm4geyBjc3JmVG9rZW46IHJlcS5jc3JmVG9rZW4/LigpIH07XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==